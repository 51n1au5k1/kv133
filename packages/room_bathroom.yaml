################################################################################
# /packages/room_bathroom.yaml
################################################################################
#
# УПРАВЛЕНИЕ ВАННОЙ КОМНАТОЙ: ВЕНТИЛЯЦИЯ + МОНИТОРИНГ
#
# ФУНКЦИИ:
# 1. Интеллектуальное управление вентилятором
#    • Автоматическое включение при высокой влажности
#    • Гистерезис порогов (защита от частых переключений)
#    • Продув перед выключением (2 минуты)
#    • Усреднённые показания влажности (1 минута)
#
# 2. Мониторинг активности
#    • Группировка датчиков движения
#    • Детекция открытия дверей (внутренняя + внешняя)
#    • Определение отсутствия активности (15 минут)
#
# УСТРОЙСТВА:
# • sensor.bathroom_th_2_humidity — датчик влажности ванной
# • fan.bathroom_relay_l1 — вентилятор ванной
# • binary_sensor.0x0ceff6fffe693347_occupancy — датчик движения #1
# • binary_sensor.0x00158d0006ebbef4_occupancy — датчик движения #2
# • binary_sensor.bathroom_door_inside_contact — датчик внутренней двери
# • binary_sensor.bathroom_door_outside_contact — датчик внешней двери
#
# ЛОГИКА УПРАВЛЕНИЯ ВЕНТИЛЯТОРОМ (ГИСТЕРЕЗИС):
# ┌──────────────────────────────────────────────────────────────────┐
# │ Влажность > 60% (верхний порог)                                  │
# │ ↓                                                                │
# │ Включение вентилятора                                            │
# │ ↓                                                                │
# │ Работа вентилятора (осушение)                                    │
# │ ↓                                                                │
# │ Влажность < 50% (нижний порог)                                   │
# │ ↓                                                                │
# │ Запуск таймера продува (2 минуты)                                │
# │ ↓                                                                │
# │ Выключение вентилятора                                           │
# └──────────────────────────────────────────────────────────────────┘
#
# ГИСТЕРЕЗИС ВЛАЖНОСТИ:
# ┌─────────────────────────────────────────────┐
# │ 60% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│ ← Включение
# │                                             │
# │ 55% - - - - - - - - - - - - - - - - - - - │
# │      ↑ Вентилятор работает                 │
# │ 50% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│ ← Начало выключения
# │      ↓ Продув 2 мин → Выключение           │
# └─────────────────────────────────────────────┘
#
################################################################################

##############################################################################
#                        НАСТРАИВАЕМЫЕ ПАРАМЕТРЫ
##############################################################################

input_number:
  # ==========================================================================
  # ПОРОГИ ВЛАЖНОСТИ (ГИСТЕРЕЗИС)
  # ==========================================================================

  bathroom_humidity_max_threshold:
    name: "Ванная: порог влажности ВКЛ (%)"
    initial: 60
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    icon: mdi:water-percent-alert

  bathroom_humidity_min_threshold:
    name: "Ванная: порог влажности ВЫКЛ (%)"
    initial: 50
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    icon: mdi:water-percent

##############################################################################
#                               ГРУППЫ
##############################################################################

group:
  # ==========================================================================
  # Группа датчиков движения в ванной
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Объединение нескольких датчиков движения в один виртуальный
  # • Упрощение логики проверки активности
  # • Группа = ON, если хотя бы один датчик обнаружил движение
  # ==========================================================================
  bathroom_motion_sensors:
    name: "Датчики движения в ванной"
    entities:
      - binary_sensor.0x0ceff6fffe693347_occupancy
      - binary_sensor.0x00158d0006ebbef4_occupancy

##############################################################################
#                          СГЛАЖЕННЫЕ СЕНСОРЫ
##############################################################################

sensor:
  # ==========================================================================
  # Усреднённая влажность ванной (1 мин скользящее среднее)
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Устранение кратковременных скачков влажности
  # • Более стабильные показания для триггеров
  # • Защита от ложных срабатываний вентилятора
  #
  # ОКНО СГЛАЖИВАНИЯ:
  # • 1 минута
  # • Достаточно для фильтрации шумов при быстрой реакции на изменения
  #
  # ТОЧНОСТЬ:
  # • 2 знака после запятой (0.01%)
  # ==========================================================================
  - platform: filter
    name: "Влажность ванной (усреднённая за 1 минуту)"
    unique_id: bathroom_humidity_smoothed_1min
    entity_id: sensor.bathroom_th_2_humidity
    filters:
      - filter: time_simple_moving_average
        window_size: "00:01"
        precision: 2

##############################################################################
#                          ВСПОМОГАТЕЛЬНЫЕ СЕНСОРЫ
##############################################################################

template:
  - sensor:
      # ======================================================================
      # Алиас усреднённой влажности с фиксированным entity_id
      # ======================================================================
      # НАЗНАЧЕНИЕ:
      # • Фиксированный entity_id для стабильных ссылок в автоматизациях
      # • Упрощение миграции при изменении имени исходного сенсора
      # • Централизованное управление доступностью
      # ======================================================================
      - name: "bathroom_filtered_humidity"
        unique_id: bathroom_filtered_humidity_alias
        state: "{{ states('sensor.vlazhnost_vannoi_usrednennaia_za_1_minutu') }}"
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        availability: >-
          {{ states('sensor.vlazhnost_vannoi_usrednennaia_za_1_minutu') not in ['unknown','unavailable',''] }}
        icon: mdi:water-percent

##############################################################################
#                          БИНАРНЫЕ СЕНСОРЫ
##############################################################################

binary_sensor:
  - platform: template
    sensors:
      # ======================================================================
      # Влажность выше верхнего порога (включение вентилятора)
      # ======================================================================
      # ЛОГИКА:
      # • ON: влажность > 60% (настраиваемый порог)
      # • OFF: влажность ≤ 60%
      #
      # НАЗНАЧЕНИЕ:
      # • Триггер для включения вентилятора
      # • Верхний порог гистерезиса
      # ======================================================================
      bathroom_humidity_max:
        unique_id: bathroom_humidity_max
        friendly_name: "Ванная: влажность выше порога"
        device_class: problem
        availability_template: >-
          {{ states('sensor.bathroom_filtered_humidity') not in ['unknown', 'unavailable', 'none', ''] }}
        value_template: >-
          {% set humidity = states('sensor.bathroom_filtered_humidity') | float(0) %}
          {% set threshold = states('input_number.bathroom_humidity_max_threshold') | float(60) %}
          {{ humidity > threshold }}
        icon_template: >-
          {% if is_state('binary_sensor.bathroom_humidity_max', 'on') %}
            mdi:water-alert
          {% else %}
            mdi:water-check
          {% endif %}

      # ======================================================================
      # Влажность ниже нижнего порога (выключение вентилятора)
      # ======================================================================
      # ЛОГИКА:
      # • ON: влажность < 50% (настраиваемый порог)
      # • OFF: влажность ≥ 50%
      #
      # НАЗНАЧЕНИЕ:
      # • Триггер для запуска продува и выключения вентилятора
      # • Нижний порог гистерезиса
      # ======================================================================
      bathroom_humidity_min:
        unique_id: bathroom_humidity_min
        friendly_name: "Ванная: влажность ниже порога"
        device_class: problem
        availability_template: >-
          {{ states('sensor.bathroom_filtered_humidity') not in ['unknown', 'unavailable', 'none', ''] }}
        value_template: >-
          {% set humidity = states('sensor.bathroom_filtered_humidity') | float(0) %}
          {% set threshold = states('input_number.bathroom_humidity_min_threshold') | float(50) %}
          {{ humidity < threshold }}
        icon_template: >-
          {% if is_state('binary_sensor.bathroom_humidity_min', 'on') %}
            mdi:water-minus
          {% else %}
            mdi:water-plus
          {% endif %}

      # ======================================================================
      # Открытие дверей ванной (внутренняя ИЛИ внешняя)
      # ======================================================================
      # ЛОГИКА:
      # • ON: хотя бы одна дверь открыта
      # • OFF: обе двери закрыты
      #
      # НАЗНАЧЕНИЕ:
      # • Детекция входа/выхода из ванной
      # • Мониторинг проветривания
      # ======================================================================
      bathroom_open_door:
        unique_id: bathroom_open_door
        friendly_name: "Ванная: дверь открыта"
        device_class: door
        availability_template: >-
          {{ states('binary_sensor.bathroom_door_inside_contact') not in ['unknown', 'unavailable']
             and states('binary_sensor.bathroom_door_outside_contact') not in ['unknown', 'unavailable'] }}
        value_template: >-
          {{ is_state('binary_sensor.bathroom_door_inside_contact', 'on') or
             is_state('binary_sensor.bathroom_door_outside_contact', 'on') }}
        icon_template: >-
          {% if is_state('binary_sensor.bathroom_open_door', 'on') %}
            mdi:door-open
          {% else %}
            mdi:door-closed
          {% endif %}

      # ======================================================================
      # Движение в ванной (объединение всех датчиков)
      # ======================================================================
      # ЛОГИКА:
      # • ON: хотя бы один датчик движения активен
      # • OFF: все датчики неактивны
      #
      # НАЗНАЧЕНИЕ:
      # • Детекция присутствия в ванной
      # • Упрощённая проверка активности
      # ======================================================================
      bathroom_motions:
        unique_id: bathroom_motions
        friendly_name: "Ванная: движение обнаружено"
        device_class: motion
        availability_template: >-
          {{ states('group.bathroom_motion_sensors') not in ['unknown', 'unavailable'] }}
        value_template: >-
          {{ is_state('group.bathroom_motion_sensors', 'on') }}
        icon_template: >-
          {% if is_state('binary_sensor.bathroom_motions', 'on') %}
            mdi:motion-sensor
          {% else %}
            mdi:motion-sensor-off
          {% endif %}

      # ======================================================================
      # Отсутствие активности в ванной (15 минут)
      # ======================================================================
      # ЛОГИКА:
      # • ON: нет движения И дверь не открывалась более 15 минут
      # • OFF: есть движение ИЛИ дверь открывалась недавно
      #
      # УСЛОВИЯ:
      # • Движение = OFF (все датчики неактивны)
      # • Дверь не открывалась > 900 секунд (15 минут)
      #
      # НАЗНАЧЕНИЕ:
      # • Детекция долгого отсутствия активности
      # • Может использоваться для дополнительных проверок
      #
      # ПРИМЕРЫ:
      # 1. Дверь открыли 10 мин назад, нет движения → OFF (ещё рано)
      # 2. Дверь открыли 20 мин назад, нет движения → ON (долго нет активности)
      # 3. Есть движение (независимо от времени) → OFF
      # ======================================================================
      no_activity_in_bathroom_recently:
        unique_id: no_activity_in_bathroom_recently
        friendly_name: "Ванная: нет активности более 15 минут"
        device_class: problem
        availability_template: >-
          {{ states('binary_sensor.bathroom_open_door') not in ['unknown', 'unavailable']
             and states('group.bathroom_motion_sensors') not in ['unknown', 'unavailable'] }}
        value_template: >-
          {% set door = states.binary_sensor.bathroom_open_door %}
          {% set motion_off = is_state('group.bathroom_motion_sensors', 'off') %}
          {% if door is not none and door.last_changed is not none %}
            {{ motion_off and (as_timestamp(now()) - as_timestamp(door.last_changed)) > 900 }}
          {% else %}
            false
          {% endif %}
        icon_template: >-
          {% if is_state('binary_sensor.no_activity_in_bathroom_recently', 'on') %}
            mdi:clock-alert
          {% else %}
            mdi:clock-check
          {% endif %}

##############################################################################
#                               ТАЙМЕРЫ
##############################################################################

timer:
  # ==========================================================================
  # Таймер продува вентилятора перед выключением
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Дополнительное осушение ванной перед выключением
  # • Продувка остаточной влаги из помещения
  # • Защита от преждевременного выключения
  #
  # ДЛИТЕЛЬНОСТЬ:
  # • 2 минуты
  # • Достаточно для удаления остаточной влаги
  #
  # ЛОГИКА:
  # • Запускается при падении влажности ниже порога
  # • После окончания — выключение вентилятора
  # ==========================================================================
  bathroom_fan_cooldown:
    name: "Ванная: продув вентилятора"
    duration: "00:02:00"
    icon: mdi:fan-clock

##############################################################################
#                             АВТОМАТИЗАЦИИ
##############################################################################

automation:
  # ==========================================================================
  # УПРАВЛЕНИЕ ВЕНТИЛЯТОРОМ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Включение вентилятора при высокой влажности
  # --------------------------------------------------------------------------
  - id: "dc1acbee-6ecd-45a4-8eae-ab69034c3117"
    alias: "Ванная: включение вентилятора (высокая влажность)"
    description: >
      Автоматически включает вентилятор при превышении верхнего порога влажности.

      ТРИГГЕР:
      • binary_sensor.bathroom_humidity_max: off → on
      • Влажность > 60% (верхний порог)

      УСЛОВИЯ:
      • Фаза запуска завершена
      • Вентилятор выключен (не дублируем включение)

      ДЕЙСТВИЯ:
      • Включение вентилятора (fan.bathroom_relay_l1)

      ГИСТЕРЕЗИС:
      • Включение: влажность > 60%
      • Выключение: влажность < 50% (в другой автоматизации)
      • Разница: 10% (защита от частых переключений)

      ПРИМЕРЫ:
      1. Влажность 55% → 62% → Вентилятор ВКЛ
      2. Влажность 62% → 58% → Вентилятор продолжает работать (ещё выше 50%)
      3. Влажность 58% → 48% → Начинается выключение (продув 2 мин)
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.bathroom_humidity_max
        to: "on"

    conditions:
      # Home Assistant полностью загружен
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"

      # Вентилятор сейчас выключен (не спамим включение)
      - condition: state
        entity_id: fan.bathroom_relay_l1
        state: "off"

    actions:
      # Включаем вентилятор
      - action: fan.turn_on
        target:
          entity_id: fan.bathroom_relay_l1

      # Логирование
      - action: system_log.write
        data:
          message: >-
            Ванная: вентилятор включён (высокая влажность).
            Текущая влажность: {{ states('sensor.bathroom_filtered_humidity') }}%.
            Порог включения: {{ states('input_number.bathroom_humidity_max_threshold') }}%.
          level: info

  # --------------------------------------------------------------------------
  # Запуск таймера продува при снижении влажности
  # --------------------------------------------------------------------------
  - id: "6ebb6fa8-9cd1-4ebd-839d-44d175e6c319"
    alias: "Ванная: запуск продува (влажность упала)"
    description: >
      Запускает таймер продува, когда влажность упала ниже нижнего порога.

      ТРИГГЕР:
      • binary_sensor.bathroom_humidity_min: off → on
      • Влажность < 50% (нижний порог)

      УСЛОВИЯ:
      • Фаза запуска завершена
      • Вентилятор включён (есть смысл дуть)
      • Таймер не активен (не запускаем дублирующий)

      ДЕЙСТВИЯ:
      • Запуск таймера bathroom_fan_cooldown (2 минуты)

      НАЗНАЧЕНИЕ:
      • Дополнительное осушение перед выключением
      • Продувка остаточной влаги
      • Защита от быстрого повторного включения

      ПОСЛЕДОВАТЕЛЬНОСТЬ:
      1. Влажность упала < 50%
      2. Запуск таймера продува (2 мин)
      3. После окончания таймера → выключение вентилятора

      ЗАЩИТА:
      • Если влажность поднимется > 60% во время продува — продув будет прерван
      • Вентилятор продолжит работать по основной логике
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.bathroom_humidity_min
        to: "on"

    conditions:
      # Home Assistant полностью загружен
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"

      # Вентилятор включён (есть смысл дуть)
      - condition: state
        entity_id: fan.bathroom_relay_l1
        state: "on"

      # Таймер не активен (не запускаем второй раз)
      - condition: state
        entity_id: timer.bathroom_fan_cooldown
        state: "idle"

    actions:
      # Запускаем таймер продува
      - action: timer.start
        target:
          entity_id: timer.bathroom_fan_cooldown

      # Логирование
      - action: script.log_helper_event
        data:
          level: info
          message: "Ванная: вентилятор включён (высокая влажность)."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.entity_id | default('') }}"
          trigger_from: >-
            {{ trigger.from_state.state
               if trigger is defined and trigger.from_state is not none
               else '' }}
          trigger_to: >-
            {{ trigger.to_state.state
               if trigger is defined and trigger.to_state is not none
               else '' }}
          extra: >-
            humidity={{ states('sensor.bathroom_filtered_humidity') }}%;
            max_thr={{ states('input_number.bathroom_humidity_max_threshold') }}%

  # --------------------------------------------------------------------------
  # Выключение вентилятора после продува
  # --------------------------------------------------------------------------
  - id: "7a1db18b-0366-47cf-8260-6109b01447f9"
    alias: "Ванная: выключение вентилятора (после продува)"
    description: >
      Выключает вентилятор после окончания таймера продува.

      ТРИГГЕР:
      • Событие: timer.finished (bathroom_fan_cooldown)

      УСЛОВИЯ (ФИНАЛЬНАЯ ПРОВЕРКА):
      • binary_sensor.bathroom_humidity_min = on (влажность всё ещё низкая)
      • Вентилятор включён (есть что выключать)

      ДЕЙСТВИЯ:
      • Выключение вентилятора

      ПОЛНЫЙ ЦИКЛ РАБОТЫ ВЕНТИЛЯТОРА:
      ┌────────────────────────────────────────────────────────────┐
      │ 1. Влажность > 60%                                        │
      │    ↓                                                       │
      │ 2. Включение вентилятора                                  │
      │    ↓                                                       │
      │ 3. Работа вентилятора (осушение)                          │
      │    ↓                                                       │
      │ 4. Влажность < 50%                                        │
      │    ↓                                                       │
      │ 5. Запуск таймера продува (2 мин)                         │
      │    ↓                                                       │
      │ 6. Выключение вентилятора ← ВЫ ЗДЕСЬ                      │
      └────────────────────────────────────────────────────────────┘

      ЗАЩИТА ОТ ПРЕЖДЕВРЕМЕННОГО ВЫКЛЮЧЕНИЯ:
      • Финальная проверка влажности перед выключением
      • Если влажность поднялась > 50% — выключение не произойдёт
      • Вентилятор продолжит работать
    mode: single
    triggers:
      - trigger: event
        event_type: timer.finished
        event_data:
          entity_id: timer.bathroom_fan_cooldown

    conditions:
      # Влажность всё ещё ниже порога (финальная проверка)
      - condition: state
        entity_id: binary_sensor.bathroom_humidity_min
        state: "on"

      # Вентилятор всё ещё работает
      - condition: state
        entity_id: fan.bathroom_relay_l1
        state: "on"

    actions:
      # Выключаем вентилятор
      - action: fan.turn_off
        target:
          entity_id: fan.bathroom_relay_l1

      # Логирование
      - action: script.log_helper_event
        data:
          level: info
          message: "Ванная: вентилятор выключен (после продува)."
          source: "{{ this.entity_id }}"
          trigger_entity: "timer.bathroom_fan_cooldown"
          trigger_from: "active"
          trigger_to: "finished"
          extra: >-
            humidity={{ states('sensor.bathroom_filtered_humidity') }}%;
            min_thr={{ states('input_number.bathroom_humidity_min_threshold') }}%
