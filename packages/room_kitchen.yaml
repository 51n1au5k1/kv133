################################################################################
# /packages/room_kitchen.yaml
################################################################################
#
# УПРАВЛЕНИЕ КУХНЕЙ: СВЕТ + МИКРОКЛИМАТ
#
# ФУНКЦИИ:
# 1. Управление освещением
#    • Основной свет (light.kitchen_main_light)
#    • Подсветка фартука (light.kitchen_fartuh)
#    • Два источника управления: кухонный + сценический выключатель
#
# 2. Контроль микроклимата
#    • Сравнение температуры/влажности кухни с гостиной
#    • Автоматическое управление вытяжкой (switch.sonoff_10024c81be)
#    • Голосовые уведомления через Яндекс.Станцию
#
# 3. Интеллектуальная логика вытяжки
#    • Гистерезис (защита от частых переключений)
#    • Антиспам уведомлений (30 мин)
#    • Задержка выключения (1 мин grace period)
#    • Абсолютные пороги (защита от работы в холодное время)
#
# УСТРОЙСТВА:
# • sensor.kitchen_th_temperature — датчик температуры кухни
# • sensor.kitchen_th_humidity — датчик влажности кухни
# • sensor.livingroom_average_temperature — средняя температура гостиной
# • sensor.livingroom_average_humidity — средняя влажность гостиной
# • switch.sonoff_10024c81be — вытяжка (Sonoff)
# • light.kitchen_main_light — основной свет
# • light.kitchen_fartuh — подсветка фартука
#
# ВЫКЛЮЧАТЕЛИ:
# • device_id: cc6ef89720abb376a24e910e13f37902 — кухонный выключатель
#   - single_right → основной свет
# • device_id: 719cda594198c3eafa3817b9230f2afa — сценический выключатель
#   - 1_single → подсветка фартука
#   - 2_single → основной свет
#
# ЗАВИСИМОСТИ:
# • helper_climate_common.yaml — усреднённые датчики гостиной
# • script.yandex_tts_kitchen_fan_alert — голосовое уведомление
#
# ЛОГИКА УПРАВЛЕНИЯ ВЫТЯЖКОЙ:
# ┌──────────────────────────────────────────────────────────────────┐
# │ Разница T/RH > порога (1 мин устойчиво)                          │
# │ ↓                                                                │
# │ Голосовое уведомление (если не было <30 мин)                     │
# │ ↓                                                                │
# │ Автовключение вытяжки                                            │
# │ ↓                                                                │
# │ Разница T/RH < порога                                            │
# │ ↓                                                                │
# │ Таймер задержки (1 мин) — grace period                           │
# │ ↓                                                                │
# │ Выключение вытяжки (если условия всё ещё нормальные)             │
# └──────────────────────────────────────────────────────────────────┘
#
################################################################################

##############################################################################
#                        НАСТРАИВАЕМЫЕ ПАРАМЕТРЫ
##############################################################################

input_number:
  # ==========================================================================
  # ГИСТЕРЕЗИС ТЕМПЕРАТУРЫ (РАЗНИЦА КУХНЯ - ГОСТИНАЯ)
  # ==========================================================================

  kitchen_temp_hysteresis_threshold_high:
    name: "Кухня: порог температуры ВКЛ (°C)"
    min: 1
    max: 10
    step: 0.5
    initial: 5
    icon: mdi:thermometer-chevron-up

  kitchen_temp_hysteresis_threshold_low:
    name: "Кухня: порог температуры ВЫКЛ (°C)"
    min: 1
    max: 10
    step: 0.5
    initial: 3
    icon: mdi:thermometer-chevron-down

  # ==========================================================================
  # ГИСТЕРЕЗИС ВЛАЖНОСТИ (РАЗНИЦА КУХНЯ - ГОСТИНАЯ)
  # ==========================================================================

  kitchen_hum_hysteresis_threshold_high:
    name: "Кухня: порог влажности ВКЛ (%)"
    min: 5
    max: 20
    step: 1
    initial: 10
    icon: mdi:water-percent

  kitchen_hum_hysteresis_threshold_low:
    name: "Кухня: порог влажности ВЫКЛ (%)"
    min: 5
    max: 20
    step: 1
    initial: 8
    icon: mdi:water-percent-alert

  # ==========================================================================
  # ТАЙМЕРЫ
  # ==========================================================================

  kitchen_notification_cooldown_min:
    name: "Кухня: интервал между уведомлениями (мин)"
    min: 5
    max: 120
    step: 5
    initial: 30
    icon: mdi:bell-sleep

  kitchen_fan_delay_min:
    name: "Кухня: задержка выключения вытяжки (мин)"
    min: 0.5
    max: 10
    step: 0.5
    initial: 1
    icon: mdi:timer-off

##############################################################################
#                          INPUT BOOLEAN
##############################################################################

input_boolean:
  # Антиспам-флаг: уже предупреждали о необходимости вытяжки
  kitchen_fan_cool_down:
    name: "Кухня: антиспам уведомлений"
    initial: off
    icon: mdi:fan-alert

##############################################################################
#                          БИНАРНЫЕ СЕНСОРЫ
##############################################################################

binary_sensor:
  - platform: template
    sensors:
      # ======================================================================
      # Индикатор необходимости вентиляции (с гистерезисом)
      # ======================================================================
      # ЛОГИКА:
      # • Сравнивает температуру и влажность кухни с гостиной
      # • Включение: разница > жёсткого порога (5°C или 10%)
      # • Выключение: разница < мягкого порога (3°C или 8%)
      # • Абсолютные пороги: T≥23°C ИЛИ RH≥45% (защита от работы зимой)
      #
      # ГИСТЕРЕЗИС:
      # ┌─────────────────────────────────────────────┐
      # │ Разница 5°C/10% ━━━━━━━━━━━━━━━━━━━━━━━━━│ ← Включение
      # │                                             │
      # │ Разница 4°C/9% - - - - - - - - - - - - - -│
      # │                                             │
      # │ Разница 3°C/8% ━━━━━━━━━━━━━━━━━━━━━━━━━│ ← Выключение
      # └─────────────────────────────────────────────┘
      #
      # АБСОЛЮТНЫЕ ПОРОГИ (ЗАЩИТА ОТ РАБОТЫ ЗИМОЙ):
      # • Температура кухни ≥ 23°C ИЛИ влажность ≥ 45%
      # • Если оба параметра ниже — вытяжка не нужна, даже если разница большая
      #
      # ПРИМЕРЫ:
      # 1. Зима: кухня 20°C, гостиная 18°C (разница 2°C)
      #    → Вытяжка НЕ нужна (T < 23°C)
      # 2. Готовка: кухня 28°C, гостиная 23°C (разница 5°C)
      #    → Вытяжка нужна (разница > порога И T ≥ 23°C)
      # 3. После готовки: кухня 25°C, гостиная 23°C (разница 2°C)
      #    → Вытяжка НЕ нужна (разница < порога выключения)
      # ======================================================================
      kitchen_need_ventilation:
        unique_id: kitchen_need_ventilation
        friendly_name: "Кухня: требуется вентиляция"
        device_class: problem
        availability_template: "true"
        value_template: >
          {% set t_k = states('sensor.kitchen_th_temperature') | float(none) %}
          {% set h_k = states('sensor.kitchen_th_humidity') | float(none) %}
          {% set t_l = states('sensor.livingroom_average_temperature') | float(none) %}
          {% set h_l = states('sensor.livingroom_average_humidity') | float(none) %}

          {# Если данных нет — сохраняем предыдущее состояние (защита от дёрганья) #}
          {% set have_all = (t_k is not none) and (h_k is not none) and (t_l is not none) and (h_l is not none) %}
          {% if not have_all %}
            {{ is_state('binary_sensor.kitchen_need_ventilation','on') }}
          {% else %}
            {# Вычисляем разницу между кухней и гостиной #}
            {% set temp_diff = (t_k - t_l) %}
            {% set hum_diff  = (h_k - h_l) %}

            {# Пороги гистерезиса #}
            {% set temp_high = states('input_number.kitchen_temp_hysteresis_threshold_high') | float(5) %}
            {% set temp_low  = states('input_number.kitchen_temp_hysteresis_threshold_low')  | float(3) %}
            {% set hum_high  = states('input_number.kitchen_hum_hysteresis_threshold_high')  | float(10) %}
            {% set hum_low   = states('input_number.kitchen_hum_hysteresis_threshold_low')   | float(8) %}

            {# Абсолютные пороги: защита от работы в холодное время #}
            {% set abs_temp_min = 23 %}
            {% set abs_hum_min  = 45 %}
            {% set abs_ok = (t_k >= abs_temp_min) or (h_k >= abs_hum_min) %}

            {# Гистерезис: разные пороги для включения и выключения #}
            {% set was_on = is_state('binary_sensor.kitchen_need_ventilation','on') %}
            {% if was_on %}
              {# Уже включена → проверяем по мягкому порогу (выключение) #}
              {{ abs_ok and (temp_diff > temp_low or hum_diff > hum_low) }}
            {% else %}
              {# Выключена → проверяем по жёсткому порогу (включение) #}
              {{ abs_ok and (temp_diff > temp_high or hum_diff > hum_high) }}
            {% endif %}
          {% endif %}
        icon_template: >-
          {% if is_state('binary_sensor.kitchen_need_ventilation', 'on') %}
            mdi:fan-alert
          {% else %}
            mdi:fan-check
          {% endif %}

##############################################################################
#                               ТАЙМЕРЫ
##############################################################################

timer:
  # ==========================================================================
  # Таймер антиспама уведомлений
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Предотвращает частые голосовые уведомления
  # • После каждого уведомления запускается на 30 минут
  # • Новое уведомление возможно только после завершения таймера
  #
  # ДЛИТЕЛЬНОСТЬ:
  # • По умолчанию: 30 минут
  # • Настраивается через input_number.kitchen_notification_cooldown_min
  # ==========================================================================
  kitchen_notification_cooldown_timer:
    name: "Кухня: антиспам уведомлений"
    duration: "00:30:00" # Базовое значение; реальная длительность задаётся динамически
    icon: mdi:bell-sleep

  # ==========================================================================
  # Таймер задержки выключения вытяжки
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Grace period перед выключением вытяжки
  # • Позволяет досушить/доохладить кухню после нормализации показателей
  #
  # ДЛИТЕЛЬНОСТЬ:
  # • По умолчанию: 1 минута
  # • Настраивается через input_number.kitchen_fan_delay_min
  # ==========================================================================
  kitchen_fan_delay_timer:
    name: "Кухня: задержка выключения вытяжки"
    duration: "00:01:00" # Базовое значение; реальная длительность задаётся динамически
    icon: mdi:timer-off

##############################################################################
#                             АВТОМАТИЗАЦИИ
##############################################################################

automation:
  # ==========================================================================
  # УПРАВЛЕНИЕ ОСВЕЩЕНИЕМ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Переключение света выключателями
  # --------------------------------------------------------------------------
  - id: "b29835d5-9911-47ec-8630-2adda70be854"
    alias: "Кухня: переключение освещения выключателями"
    description: >
      Управление основным светом и подсветкой фартука через выключатели.

      ИСТОЧНИКИ УПРАВЛЕНИЯ:
      1. Кухонный выключатель (cc6ef89720abb376a24e910e13f37902)
         • Правая клавиша (single_right) → основной свет

      2. Сценический выключатель (719cda594198c3eafa3817b9230f2afa)
         • Кнопка 1 (1_single) → подсветка фартука
         • Кнопка 2 (2_single) → основной свет

      РЕЖИМ:
      • restart — новое нажатие прерывает предыдущее действие
      • Защита от конфликтов при быстрых нажатиях

      ПРИМЕЧАНИЕ:
      • Назначение кнопок можно изменить, заменив entity_id в соответствующих блоках
      • Закомментированные варианты показывают альтернативные конфигурации
    mode: restart
    triggers:
      # Кухонный выключатель: правая клавиша
      - trigger: device
        domain: mqtt
        device_id: cc6ef89720abb376a24e910e13f37902
        type: action
        subtype: single_right
        id: kitchen_switch_right

      # Сценический выключатель: кнопка 1
      - trigger: device
        domain: mqtt
        device_id: 719cda594198c3eafa3817b9230f2afa
        type: action
        subtype: 1_single
        id: scenic_1_single

      # Сценический выключатель: кнопка 2
      - trigger: device
        domain: mqtt
        device_id: 719cda594198c3eafa3817b9230f2afa
        type: action
        subtype: 2_single
        id: scenic_2_single

    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"

    actions:
      - choose:
          # ====================================================================
          # Кухонный выключатель: правая клавиша → основной свет
          # ====================================================================
          - conditions:
              - condition: trigger
                id: kitchen_switch_right
            sequence:
              - action: light.toggle
                target:
                  entity_id: light.kitchen_main_light
                  # АЛЬТЕРНАТИВА: если правая клавиша управляет фартуком
                  # entity_id: light.kitchen_fartuh

          # ====================================================================
          # Сценический выключатель: кнопка 1 → подсветка фартука
          # ====================================================================
          - conditions:
              - condition: trigger
                id: scenic_1_single
            sequence:
              - action: light.toggle
                target:
                  entity_id: light.kitchen_fartuh
                  # АЛЬТЕРНАТИВА: если кнопка 1 управляет основным светом
                  # entity_id: light.kitchen_main_light

          # ====================================================================
          # Сценический выключатель: кнопка 2 → основной свет
          # ====================================================================
          - conditions:
              - condition: trigger
                id: scenic_2_single
            sequence:
              - action: light.toggle
                target:
                  entity_id: light.kitchen_main_light
                  # АЛЬТЕРНАТИВА: если кнопка 2 управляет фартуком
                  # entity_id: light.kitchen_fartuh

  # ==========================================================================
  # УПРАВЛЕНИЕ МИКРОКЛИМАТОМ И ВЫТЯЖКОЙ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Голосовое предупреждение о необходимости вытяжки (с антиспамом)
  # --------------------------------------------------------------------------
  - id: "dc8af8f7-c0f5-4244-867b-00fc546039ba"
    alias: "Кухня: голосовое уведомление о вытяжке (с антиспамом)"
    description: >
      Озвучивает предупреждение через Яндекс.Станцию при перегреве/переувлажнении кухни.

      ТРИГГЕР:
      • binary_sensor.kitchen_need_ventilation: off → on
      • Разница температуры/влажности превысила порог

      УСЛОВИЯ (ВСЕ ДОЛЖНЫ БЫТЬ ВЫПОЛНЕНЫ):
      • Антиспам выключен (kitchen_fan_cool_down = off)
      • Таймер антиспама не активен (idle)
      • Фаза запуска завершена
      • Режим тишины выключен

      ДЕЙСТВИЯ:
      1. Голосовое уведомление (script.yandex_tts_kitchen_fan_alert)
      2. Включение флага антиспама (kitchen_fan_cool_down = on)
      3. Запуск таймера антиспама (30 мин)

      ЛОГИКА АНТИСПАМА:
      ┌────────────────────────────────────────┐
      │ Уведомление отправлено                 │
      │ ↓                                      │
      │ Флаг антиспама = ON                    │
      │ ↓                                      │
      │ Таймер 30 мин                          │
      │ ↓                                      │
      │ Возможно новое уведомление             │
      └────────────────────────────────────────┘

      ЗАЩИТА ОТ СПАМА:
      • Максимум 1 уведомление за 30 минут
      • Даже если условия улучшились и снова ухудшились
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.kitchen_need_ventilation
        from: "off"
        to: "on"
    conditions:
      - condition: state
        entity_id: input_boolean.kitchen_fan_cool_down
        state: "off"
      - condition: state
        entity_id: timer.kitchen_notification_cooldown_timer
        state: "idle"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
    actions:
      # Голосовое уведомление через Яндекс.Станцию
      - action: script.yandex_tts_kitchen_fan_alert

      # Включаем флаг антиспама
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.kitchen_fan_cool_down

      # Запускаем таймер антиспама
      - action: timer.start
        target:
          entity_id: timer.kitchen_notification_cooldown_timer
        data:
          duration: "{{ (states('input_number.kitchen_notification_cooldown_min') | float(30) * 60) | int }}"

  # --------------------------------------------------------------------------
  # Сброс флага антиспама при нормализации условий
  # --------------------------------------------------------------------------
  - id: "8b7c3a73-7d74-4e6f-b1d5-4a9c1e3a9c12"
    alias: "Кухня: сброс флага антиспама (условия нормализовались)"
    description: >
      Сбрасывает флаг антиспама, когда условия нормализовались.

      ТРИГГЕР:
      • binary_sensor.kitchen_need_ventilation: on → off
      • Разница температуры/влажности ниже порога выключения

      ДЕЙСТВИЯ:
      • Сброс флага kitchen_fan_cool_down = off

      НАЗНАЧЕНИЕ:
      • Разрешает новое уведомление, если условия снова ухудшатся
      • Не сбрасывает таймер (таймер работает независимо)

      ЛОГИКА:
      • Флаг сбрасывается немедленно при улучшении условий
      • Таймер продолжает отсчёт (дополнительная защита от спама)
      • Новое уведомление возможно только когда И флаг, И таймер готовы
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.kitchen_need_ventilation
        from: "on"
        to: "off"
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.kitchen_fan_cool_down

  # --------------------------------------------------------------------------
  # HELPER: сброс флага при старте Home Assistant
  # --------------------------------------------------------------------------
  - id: "10f4f44c-a559-4281-9a1b-18aac1fd845b"
    alias: "Кухня: сброс флага антиспама при старте HA"
    description: >
      Сбрасывает флаг антиспама при старте Home Assistant, если условия нормальные.

      ТРИГГЕР:
      • Событие: homeassistant.start

      УСЛОВИЯ:
      • binary_sensor.kitchen_need_ventilation = off

      ДЕЙСТВИЯ:
      • Сброс флага kitchen_fan_cool_down = off

      НАЗНАЧЕНИЕ:
      • Очистка состояния после перезапуска HA
      • Предотвращает "застревание" флага антиспама
      • Гарантирует корректную работу после рестарта
    mode: single
    triggers:
      - trigger: homeassistant
        event: start
    conditions:
      - condition: state
        entity_id: binary_sensor.kitchen_need_ventilation
        state: "off"
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.kitchen_fan_cool_down

  # --------------------------------------------------------------------------
  # Автоматическое включение вытяжки
  # --------------------------------------------------------------------------
  - id: "e2d5d614-46cf-4706-9bfe-7a17cd81f0c1"
    alias: "Кухня: автоматическое включение вытяжки"
    description: >
      Автоматически включает вытяжку при устойчивом превышении порогов.

      ТРИГГЕР:
      • binary_sensor.kitchen_need_ventilation: off → on
      • Условия плохие устойчиво ≥ 1 минуты (защита от кратковременных скачков)

      УСЛОВИЯ:
      • Фаза запуска завершена
      • Вытяжка ещё выключена (switch.sonoff_10024c81be = off)

      ДЕЙСТВИЯ:
      • Включение вытяжки (switch.sonoff_10024c81be = on)

      ЗАДЕРЖКА 1 МИНУТА:
      • Защита от ложных срабатываний
      • Подтверждение устойчивого превышения порогов
      • Предотвращает включение при кратковременных скачках

      ПРИМЕРЫ:
      1. Кратковременный скачок (10 секунд) → вытяжка НЕ включится
      2. Устойчивый перегрев (2 минуты) → вытяжка включится через 1 минуту

      ПОСЛЕДОВАТЕЛЬНОСТЬ:
      1. Условия ухудшились → binary_sensor = on
      2. Ожидание 1 минута (подтверждение)
      3. Включение вытяжки
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.kitchen_need_ventilation
        from: "off"
        to: "on"
        for:
          minutes: 1 # Устойчивое превышение порогов 1 минуту
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: switch.sonoff_10024c81be
        state: "off"
    actions:
      - action: switch.turn_on
        target:
          entity_id: switch.sonoff_10024c81be

  # --------------------------------------------------------------------------
  # Запуск таймера задержки выключения вытяжки
  # --------------------------------------------------------------------------
  - id: "d2986069-fb9c-4425-afc7-1b17f96cfff3"
    alias: "Кухня: запуск таймера задержки выключения вытяжки"
    description: >
      Запускает таймер задержки выключения при нормализации условий.

      ТРИГГЕР:
      • binary_sensor.kitchen_need_ventilation: on → off
      • Разница температуры/влажности упала ниже порога выключения

      УСЛОВИЯ:
      • Вытяжка всё ещё включена (switch.sonoff_10024c81be = on)

      ДЕЙСТВИЯ:
      • Запуск таймера kitchen_fan_delay_timer (1 мин)

      НАЗНАЧЕНИЕ ЗАДЕРЖКИ:
      • Grace period перед выключением
      • Позволяет досушить/доохладить кухню
      • Предотвращает быстрое повторное включение

      ЛОГИКА:
      ┌────────────────────────────────────────┐
      │ Условия нормализовались                │
      │ ↓                                      │
      │ Таймер задержки 1 мин                  │
      │ ↓                                      │
      │ Выключение вытяжки                     │
      └────────────────────────────────────────┘

      ЗАЩИТА:
      • Если условия ухудшатся во время таймера — таймер отменится
      • Вытяжка продолжит работать
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.kitchen_need_ventilation
        from: "on"
        to: "off"
    conditions:
      - condition: state
        entity_id: switch.sonoff_10024c81be
        state: "on"
    actions:
      - action: timer.start
        target:
          entity_id: timer.kitchen_fan_delay_timer
        data:
          duration: "{{ (states('input_number.kitchen_fan_delay_min') | float(1) * 60) | int }}"

  # --------------------------------------------------------------------------
  # Выключение вытяжки по таймеру
  # --------------------------------------------------------------------------
  - id: "95fecbf7-3ac8-4b4a-a7a8-a857a307be68"
    alias: "Кухня: выключение вытяжки по таймеру"
    description: >
      Финальное выключение вытяжки после завершения таймера задержки.

      ТРИГГЕР:
      • Событие: timer.finished (kitchen_fan_delay_timer)

      УСЛОВИЯ (ФИНАЛЬНАЯ ПРОВЕРКА):
      • binary_sensor.kitchen_need_ventilation = off
      • Подтверждение, что условия всё ещё нормальные

      ДЕЙСТВИЯ:
      • Выключение вытяжки (switch.sonoff_10024c81be = off)

      ПОЛНЫЙ ЦИКЛ РАБОТЫ ВЫТЯЖКИ:
      ┌────────────────────────────────────────────────────────────┐
      │ 1. Условия ухудшились (разница > порога)                  │
      │    ↓                                                       │
      │ 2. Ожидание 1 мин (подтверждение)                         │
      │    ↓                                                       │
      │ 3. Включение вытяжки + голосовое уведомление              │
      │    ↓                                                       │
      │ 4. Работа вытяжки                                         │
      │    ↓                                                       │
      │ 5. Условия нормализовались (разница < порога)             │
      │    ↓                                                       │
      │ 6. Таймер задержки 1 мин (grace period)                   │
      │    ↓                                                       │
      │ 7. Выключение вытяжки ← ВЫ ЗДЕСЬ                          │
      └────────────────────────────────────────────────────────────┘

      ЗАЩИТА ОТ ПРЕЖДЕВРЕМЕННОГО ВЫКЛЮЧЕНИЯ:
      • Если условия ухудшились во время таймера — выключение не произойдёт
      • Финальная проверка перед выключением
    mode: single
    triggers:
      - trigger: event
        event_type: timer.finished
        event_data:
          entity_id: timer.kitchen_fan_delay_timer
    conditions:
      - condition: state
        entity_id: binary_sensor.kitchen_need_ventilation
        state: "off"
    actions:
      - action: switch.turn_off
        target:
          entity_id: switch.sonoff_10024c81be
