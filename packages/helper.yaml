################################################################################
# /packages/helper.yaml
################################################################################
#
# ГЛОБАЛЬНЫЕ ХЕЛПЕРЫ СИСТЕМЫ
#
# Содержит общие, не привязанные к комнатам или устройствам сущности:
#
# 1. МОНИТОРИНГ СИСТЕМЫ
#    • Размер БД MariaDB
#    • Фаза загрузки (system_startup_phase)
#    • Присутствие (someone_is_home, andrei_is_home)
#
# 2. ГЛОБАЛЬНЫЕ РЕЖИМЫ
#    • Режим тишины (23:00–09:00)
#    • Режим уборки в ванной
#    • Форсированное отключение камер
#
# 3. АВТОМАТИЗАЦИЯ УСТРОЙСТВ ПРИ ОТСУТСТВИИ
#    • Камеры: включаются через 2 мин после ухода
#    • Отпариватель: выключается при уходе
#    • Свет + ТВ: выключаются в будни 09:00–17:00
#
# 4. ТЕХНИЧЕСКИЕ ХЕЛПЕРЫ
#    • Флаги стиральной машины (цикл, pre_restart)
#    • Очистка БД (recorder.purge в 03:40)
#    • Сброс флагов при старте
#
# 5. ГРУППЫ
#    • all_residents, cameras, living_room_tv
#
# ПРИМЕЧАНИЕ:
# ВСЁ, ЧТО КАСАЕТСЯ КЛИМАТА, ВЫНЕСЕНО В:
# • helper_climate_common.yaml — инфраструктура
# • room_livingroom_*.yaml — логика устройств
#
################################################################################

################################################################################
#                               СЕНСОРЫ
################################################################################
#
# SQL-СЕНСОРЫ:
# • maria_db_size — размер БД MariaDB (контроль разрастания)
#
# ШАБЛОННЫЕ СЕНСОРЫ:
# • doors_in_kitchen_livingroom — состояние балконных дверей
# • andrei_is_home — присутствие на основе WiFi + person
# • someone_is_home — кто-то из жильцов дома
# • livingroom_sockets_power_total — суммарная мощность розеток
#
################################################################################

sensor:
  # --------------------------------------------------------------------------
  # Измерение размера БД MariaDB
  # --------------------------------------------------------------------------
  # SQL-сенсор, который выполняет запрос к таблице information_schema.tables
  # и вычисляет общий размер (данные + индексы) в мегабайтах для схемы "homeassistant".
  # Используется для наблюдения за разрастанием БД.
  - platform: sql
    db_url: !secret db_link
    queries:
      - name: Maria DB size
        query: >
          SELECT 
            table_schema AS "database", 
            ROUND(SUM(data_length + index_length) / 1048576, 2) AS "value" 
          FROM information_schema.tables 
          WHERE table_schema = "homeassistant" 
          GROUP BY table_schema;
        column: "value"
        unit_of_measurement: MB

##############################################################################
#                           ШАБЛОННЫЕ СЕНСОРЫ
##############################################################################
#
# Блок template-сенсоров, которые могут быть использованы для вычисления
# или хранения постоянных (фиксированных) значений, недоступных в виде отдельных
# физических датчиков. В этом случае задан «Норма атмосферного давления» --
# постоянное значение, которое можно, например, сравнивать с реальным
# давлением, получаемым от другого датчика.
#
# Вы можете использовать этот сенсор в автоматизациях или в карточках Lovelace,
# если хотите проверить отклонение текущего давления от «нормы», а также
# отображать его в интерфейсе.
#
##############################################################################

template:
  - binary_sensor:
      # Кто-то дома
      - name: someone_is_home
        device_class: occupancy
        state: >
          {{ expand('group.all_residents') | selectattr('state','eq','home') | list | length > 0 }}

      # Андрей дома
      - name: andrei_is_home
        device_class: occupancy
        availability: >
          {{ states('sensor.pixel_8_pro_wi_fi_connection') not in ['unknown','unavailable'] }}
        state: >
          {{ is_state('person.master','home') 
             or is_state('sensor.pixel_8_pro_wi_fi_connection','mdhouse') }}

      # Любая дверь на балкон открыта -> on
      - name: doors_in_kitchen_livingroom
        device_class: door
        state: >
          {% set sensors = [
            'binary_sensor.gostinaia_balkon_contact',
            'binary_sensor.0x00158d0003ce9922_contact'
          ] %}
          {{ sensors | select('is_state', 'on') | list | length > 0 }}

  - sensor:
      - name: livingroom_sockets_power_total
        unique_id: livingroom_sockets_power_total
        unit_of_measurement: W
        state: >
          {{ states('sensor.livingroom_socket_l_power')|float(0)
           + states('sensor.livingroom_socket_r_power')|float(0) }}

##############################################################################
#  ВХОДНЫЕ ПАРАМЕТРЫ
#  Входные переменные сохраняются между перезагрузками системы
##############################################################################
#  ВХОДНЫЕ БУЛЕВЫ (INPUT_BOOLEAN)
#############################################################################
#
# Блок булевых сенсоров, которые служат для переключения и учета различных
# состояний и режимов в системе Home Assistant. Это могут быть как технические
# (при загрузке системы, при необходимости выключить уведомления), так и
# пользовательские режимы (режим тишины, зимний режим и т.д.).
#
# Использование input_boolean упрощает логику автоматизаций, делая её более
# наглядной и гибкой. Ниже описано каждое поле, его назначение и начальное
# значение (initial).
#
##############################################################################

input_boolean:
  # --------------------------------------------------------------------------
  # Фаза загрузки системы
  # --
  # Активируется при старте Home Assistant, указывая, что система в процессе
  # загрузки (например, чтобы временно приостановить срабатывание некоторых
  # автоматизаций). Позже автоматически отключается.
  system_startup_phase:
    name: "Фаза загрузки системы"
    initial: on
    icon: mdi:timer-sand

  # --------------------------------------------------------------------------
  # Режим тишины
  # --
  # Используется, чтобы переключать «тихий режим» в определенные часы суток
  # (23:00--09:00 по умолчанию). В этом режиме система блокирует громкие
  # уведомления или отключает/уменьшает громкость оповещений.
  #
  # Если пользователь вручную включает silent_mode в другое время,
  # автоматизация все равно переключит его в off в 09:00 на следующий день,
  # обеспечивая гарантированный выход из режима тишины.
  silent_mode:
    name: "Режим тишины"
    initial: off
    icon: mdi:emoticon-neutral-outline

  # --------------------------------------------------------------------------
  # Режим уборки в ванной
  # --
  # Может использоваться для автоматизаций, связанных с уборкой:
  # включение вытяжки, освещения или других устройств в ванной
  # в «режиме уборки», чтобы удобно и безопасно заниматься чисткой/мойкой.
  bathroom_cleaning_mode:
    name: "Режим уборки в ванной"
    initial: off
    icon: mdi:broom

  # ==========================================================================
  # УПРАВЛЕНИЕ УСТРОЙСТВАМИ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Форсированное отключение камер
  # --------------------------------------------------------------------------
  # Переключатель для принудительного отключения камер независимо от присутствия.
  # Используется для обслуживания или по требованию приватности.
  force_camera_off:
    name: "Форсированное отключение камер"
    initial: off
    icon: mdi:cctv-off
  # ==========================================================================
  # ЗАЩИТА УСТРОЙСТВ ПРИ СТАРТЕ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Защита освещения ванной
  # --------------------------------------------------------------------------
  # Предотвращает случайное включение света в ванной при старте HA.
  bathroom_lights_startup_protection:
    name: "Защита освещения ванной при запуске"
    initial: on
    icon: mdi:shield-home
  # ==========================================================================
  # СТИРАЛЬНАЯ МАШИНА
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Флаг активного цикла стирки
  # --------------------------------------------------------------------------
  # Отмечает, что цикл стирки начался после текущего запуска HA.
  wm_cycle_seen_start:
    name: "Стиралка: цикл начинался после текущего старта HA"
    initial: off
    icon: mdi:flag-outline
  # --------------------------------------------------------------------------
  # Статус работы стиральной машины
  # --------------------------------------------------------------------------
  washing_machine_running:
    name: "Стиральная машина работает"
    initial: off
    icon: mdi:washing-machine
  # --------------------------------------------------------------------------
  # Состояние до перезагрузки
  # --------------------------------------------------------------------------
  # Сохраняет состояние стиралки перед shutdown, чтобы восстановить после старта.
  washing_machine_pre_restart_state:
    name: "Washing Machine Pre-Restart State"
    initial: off
    icon: mdi:washing-machine
  # --------------------------------------------------------------------------
  # Авария питания
  # --------------------------------------------------------------------------
  # Активируется при отключении розетки стиральной машины.
  wm_socket_outage_active:
    name: "Стиралка: авария питания активна"
    initial: off
    icon: mdi:power-plug-off

  # --------------------------------------------------------------------------
  # Хелпер-флаг уведомлений о звонке в дверь
  # --

  doorbell_spam_guard:
    name: Doorbell spam guard
    icon: mdi:bell-badge
  # --------------------------------------------------------------------------
  # Хелпер-флаг стабильности работы интеграции Xiaomi Home
  # --
  xiaomi_home_integration_unstable:
    name: "Xiaomi Home: интеграция нестабильна"
    initial: off
    icon: mdi:alert-circle

##############################################################################
#  ВХОДНЫЕ ТЕКСТОВЫЕ (INPUT_TEXT)
#############################################################################
input_text:
  # ----------------------------------------------------------------------------
  # Текстовое поле, которое в автоматизации "Обновление списка пользователей,
  # находящихся дома" хранит список имен тех, кто фактически находится дома.
  # ----------------------------------------------------------------------------
  currently_home:
    name: "Currently Home"
    min: 0
    max: 255

##############################################################################
#                                 ГРУППЫ
##############################################################################
#
# Группировка сущностей для удобного контроля присутствия пользователей.
# group.all_residents указывает, что «дом» считается занятым,
# если хотя бы один человек (master или tatiana) находится дома.
#
##############################################################################

group:
  all_residents:
    name: "Все Жильцы"
    entities:
      - person.master
  #      - person.tatiana

  # ----------------------------------------------------------------------------
  # Группа камер
  # ----------------------------------------------------------------------------
  cameras:
    name: "Камеры"
    entities:
      - switch.chuangmi_cn_309825146_ipc019_on_p_2_1
      - switch.chuangmi_cn_311366982_ipc019_on_p_2_1

  # ----------------------------------------------------------------------------
  # Группа телевизоров в гостиной
  # ----------------------------------------------------------------------------
  living_room_tv:
    name: "Телевизоры в гостиной"
    entities:
      - media_player.televizor_v_gostinoi
      - media_player.televizor_v_gostinoi_2
      - media_player.android_tv_192_168_100_171
      - media_player.samsung_q70_series_55

##############################################################################
# УНИВЕРСАЛЬНЫЙ СКРИПТ ЛОГИРОВАНИЯ
##############################################################################
script:
  log_helper_event:
    alias: "HELPER SCRIPT: Логирование события"
    description: "Единая точка для записи сообщений в system_log с контекстом и опциональным уведомлением в Telegram."
    mode: parallel
    fields:
      level:
        description: "Уровень лога: debug, info, warning, error, critical"
        example: "info"
      message:
        description: "Основной текст сообщения"
        example: "Silent mode ON"
      source:
        description: "Идентификатор автоматики или скрипта-инициатора"
        example: "automation.helper_silent_mode_on"
      trigger_entity:
        description: "Сущность, сработавшая как триггер"
        example: "binary_sensor.someone_is_home_2"
      trigger_from:
        description: "Старое состояние триггера"
        example: "on"
      trigger_to:
        description: "Новое состояние триггера"
        example: "off"
      extra:
        description: "Дополнительный контекст (строка)"
        example: "keep_days=90"
      notify:
        description: >
          Отправить уведомление в Telegram (true/false).
          При level=error/critical уведомление отправляется всегда, даже если notify не задано.
        example: true
    sequence:
      - variables:
          _level: "{{ (level | default('info')) | lower }}"
          _source: "{{ source | default(this.entity_id) }}"
          _trigger_entity: "{{ trigger_entity | default('') }}"
          _trigger_from: "{{ trigger_from | default('') }}"
          _trigger_to: "{{ trigger_to | default('') }}"
          _extra: "{{ extra | default('') }}"
          _notify_request: "{{ notify | default(false) }}"
          _should_notify: >
            {{ _notify_request or _level in ['error', 'critical'] }}

      - service: system_log.write
        data:
          level: >
            {% set allowed = ['debug','info','warning','error','critical'] %}
            {{ _level if _level in allowed else 'info' }}
          message: >
            [{{ _source }}] {{ message }}
            {% if _trigger_entity %}
              | trigger={{ _trigger_entity }}
            {% endif %}
            {% if _trigger_from %}
              | from={{ _trigger_from }}
            {% endif %}
            {% if _trigger_to %}
              | to={{ _trigger_to }}
            {% endif %}
            {% if _extra %}
              | {{ _extra }}
            {% endif %}

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ _should_notify }}"
            sequence:
              - action: notify.send_message
                target:
                  entity_id: notify.telegram_master
                data:
                  message: |-
                    [{{ _level | upper }}] {{ message }}
                    source: {{ _source }}
                    {% if _trigger_entity %}
                    trigger: {{ _trigger_entity }} ({{ _trigger_from }} → {{ _trigger_to }})
                    {% endif %}
                    {% if _extra %}
                    extra: {{ _extra }}
                    {% endif %}

##############################################################################
#                             АВТОМАТИЗАЦИИ
##############################################################################
#
# Ниже собраны автоматизации, упрощающие управление системой:
# • Обновление списка пользователей, находящихся дома.
# • Переключение зимнего режима по месяцам.
# • Управление фазой загрузки системы (включение/отключение).
# • Автоматический режим тишины (включение в 23:00, снятие в 09:00).
# • Сброс уведомлений о CO2 при завершении проветривания.
# • Сохранение/восстановление состояний климатических приборов при выключении/старте HA.
# • Управление камерами в зависимости от присутствия.
# • Очистка базы данных MariaDB.
# • Дополнительные автоматизации для управления освещением, розеткой отпаривателя
#   и ТВ в рабочие дни, а также автономное отключение отпаривателя при отсутствии дома.
#
##############################################################################

automation:
  # --------------------------------------------------------------------------
  # HELPER: Xiaomi Home — интеграция упала (по MQTT offline)
  # --------------------------------------------------------------------------
  - id: "3626d8f6-8b1b-45ac-913e-bbacea4ed5b6"
    alias: "HELPER: Xiaomi Home — интеграция нестабильна"
    mode: single
    trigger:
      - platform: mqtt
        topic: "xiaomi/your_doorbell/status" # ← сюда реальный топик
        payload: "offline"
    action:
      # Включаем флаг "нестабильно"
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.xiaomi_home_integration_unstable

      # Логируем для отладки + уведомление (warning + notify)
      - action: script.log_helper_event
        data:
          level: warning
          message: "Xiaomi Home: получен MQTT offline, флаг unstable = on (на 30 секунд)."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.topic | default('') }}"
          trigger_from: ""
          trigger_to: "{{ trigger.payload | default('offline') }}"
          extra: "action=set_unstable_flag;duration=30s"
          notify: true

      # Через 30 секунд считаем, что система восстановилась
      - delay: "00:00:30"

      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.xiaomi_home_integration_unstable

      # Логируем сброс флага (без уведомления)
      - action: script.log_helper_event
        data:
          level: info
          message: "Xiaomi Home: unstable flag reset to off после 30 секунд."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.topic | default('') }}"
          trigger_from: "offline"
          trigger_to: "online?"
          extra: "action=clear_unstable_flag"

  # ----------------------------------------------------------------------------
  # Обновление списка пользователей, находящихся дома
  # ----------------------------------------------------------------------------
  - id: "c6382818-05ed-4590-be92-b367489fb0e1"
    alias: "HELPER: Обновление списка пользователей, находящихся дома"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.andrei_is_home
          - person.master
    actions:
      - action: input_text.set_value
        target:
          entity_id: input_text.currently_home
        data:
          value: >
            {% set home_users = [] %}
            {% if is_state('binary_sensor.andrei_is_home', 'on') %}
              {% set home_users = home_users + ['Andrei'] %}
            {% endif %}
            {{ home_users | join(', ') }}
      - action: script.log_helper_event
        data:
          level: info
          message: >
            currently_home обновлён до '{{ states('input_text.currently_home') }}'.
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.entity_id | default('') }}"
          trigger_from: "{{ trigger.from_state.state | default('') }}"
          trigger_to: "{{ trigger.to_state.state | default('') }}"
          extra: ""

  # --------------------------------------------------------------------------
  # Фаза загрузки: включение флага при старте HA
  # --------------------------------------------------------------------------
  - id: "38ea50fb-09bc-4d39-a771-1727ab72f265"
    alias: "HELPER: Фаза: Включение датчика загрузки"
    description: "Активируем system_startup_phase при старте Home Assistant"
    mode: single
    triggers:
      - trigger: homeassistant
        event: start
    actions:
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.system_startup_phase
      - action: script.log_helper_event
        data:
          level: info
          message: "system_startup_phase = ON (Home Assistant start)."
          source: "{{ this.entity_id }}"
          trigger_entity: "homeassistant.start"
          trigger_from: ""
          trigger_to: ""
          extra: ""

  # --------------------------------------------------------------------------
  # Фаза загрузки: автоотключение флага через 2 мин после старта HA
  # --------------------------------------------------------------------------
  - id: "03e3ffd0-4e1e-4200-b0e3-1ce6a2d77d6a"
    alias: "HELPER: Фаза: Отключение датчика загрузки (2 минуты)"
    description: "Через 2 минуты после старта выключаем system_startup_phase"
    mode: single
    triggers:
      - trigger: homeassistant
        event: start
    actions:
      - delay: "00:02:00"
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.system_startup_phase

  # --------------------------------------------------------------------------
  # Режим тишины (23:00 включить silent_mode)
  # --------------------------------------------------------------------------
  - id: "cc269239-a6dd-422f-ba2a-3d57e4c5981e"
    alias: "HELPER: Установка режима тишины (23:00)"
    description: >
      Включает silent_mode каждый день в 23:00.
      В этом режиме:
      • TTS-оповещения отключаются
      • Уведомления идут только в Telegram
    mode: single
    triggers:
      - trigger: time
        at: "23:00:00"
    actions:
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.silent_mode
      - action: script.log_helper_event
        data:
          level: info
          message: "Silent mode включён по расписанию 23:00."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.entity_id | default('') }}"
          trigger_from: "{{ trigger.from_state.state | default('') }}"
          trigger_to: "{{ trigger.to_state.state | default('') }}"
          extra: "silent_mode=on"

  # --------------------------------------------------------------------------
  # Режим тишины (09:00 снять silent_mode)
  # --------------------------------------------------------------------------
  - id: "6ed14663-ebe5-4ab3-bc3b-43e682c45f3b"
    alias: "HELPER: Снятие режима тишины (09:00)"
    description: >
      Выключает silent_mode каждый день в 09:00.
      После этого:
      • TTS-оповещения возобновляются
      • Громкие уведомления разблокированы
    mode: single
    triggers:
      - trigger: time
        at: "09:00:00"
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.silent_mode
      - action: script.log_helper_event
        data:
          level: info
          message: "Silent mode выключен по расписанию 09:00."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.entity_id | default('') }}"
          trigger_from: "{{ trigger.from_state.state | default('') }}"
          trigger_to: "{{ trigger.to_state.state | default('') }}"
          extra: "silent_mode=off"

  # ----------------------------------------------------------------------------
  # Управление камерами в зависимости от присутствия
  # ----------------------------------------------------------------------------
  - id: "bee019e8-c011-4283-85df-4cbbbc00e92f"
    alias: "Камеры: Управление в зависимости от присутствия"
    description: "Вкл/выкл камер по факту присутствия, с антифлаппингом и без дублей."
    mode: single
    triggers:
      # устойчиво НИКОГО НЕТ дома 2 минуты
      - trigger: state
        entity_id: binary_sensor.someone_is_home_2
        to: "off"
        for: "00:02:00"
        id: away
      # устойчиво КТО-ТО ДОМА 2 минуты
      - trigger: state
        entity_id: binary_sensor.someone_is_home_2
        to: "on"
        for: "00:02:00"
        id: home
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.force_camera_off
        state: "off"
    actions:
      - choose:
          - conditions:
              - condition: trigger
                id: away
              - condition: state
                entity_id: group.cameras
                state: "off"
            sequence:
              - action: switch.turn_on
                target:
                  entity_id: group.cameras
              - action: notify.send_message
                target:
                  entity_id: notify.telegram_master
                data:
                  message: "Камеры включены: Никого нет дома."
              - action: script.log_helper_event
                data:
                  level: info
                  message: "Камеры включены (никого нет дома ≥ 2 минуты)."
                  source: "{{ this.entity_id }}"
                  trigger_entity: "{{ trigger.entity_id | default('') }}"
                  trigger_from: "{{ trigger.from_state.state | default('') }}"
                  trigger_to: "{{ trigger.to_state.state | default('') }}"
                  extra: "action=cameras_on;reason=away_state"
          - conditions:
              - condition: trigger
                id: home
              - condition: state
                entity_id: group.cameras
                state: "on"
            sequence:
              - action: switch.turn_off
                target:
                  entity_id: group.cameras
              - action: notify.send_message
                target:
                  entity_id: notify.telegram_master
                data:
                  message: "Камеры выключены: Кто-то дома."
              - action: script.log_helper_event
                data:
                  level: info
                  message: "Камеры выключены (кто-то дома ≥ 2 минуты)."
                  source: "{{ this.entity_id }}"
                  trigger_entity: "{{ trigger.entity_id | default('') }}"
                  trigger_from: "{{ trigger.from_state.state | default('') }}"
                  trigger_to: "{{ trigger.to_state.state | default('') }}"
                  extra: "action=cameras_off;reason=home_state"

  # --------------------------------------------------------------------------
  # Блокировка включения камер при force_camera_off
  # --------------------------------------------------------------------------
  - id: "98df0b92-1c60-4e48-a065-3412a0706124"
    alias: "Камеры: Блокировка включения при форсированном отключении"
    description: >
      Не даём включиться камерам, если активирован режим форсированного отключения.
    mode: parallel
    triggers:
      - trigger: state
        entity_id:
          - switch.chuangmi_cn_309825146_ipc019_on_p_2_1
          - switch.chuangmi_cn_311366982_ipc019_on_p_2_1
        to: "on"
    conditions:
      - condition: state
        entity_id: input_boolean.force_camera_off
        state: "on"
    actions:
      - action: switch.turn_off
        target:
          entity_id:
            - switch.chuangmi_cn_309825146_ipc019_on_p_2_1
            - switch.chuangmi_cn_311366982_ipc019_on_p_2_1
      - action: notify.send_message
        target:
          entity_id: notify.telegram_master
        data:
          message: "Попытка включения камер заблокирована (форсированное отключение)."
      - action: script.log_helper_event
        data:
          level: warning
          message: "Попытка включения камер заблокирована (force_camera_off=on)."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.entity_id | default('') }}"
          trigger_from: "{{ trigger.from_state.state | default('') }}"
          trigger_to: "{{ trigger.to_state.state | default('') }}"
          extra: "action=block_cameras"

  # --------------------------------------------------------------------------
  # Очистка базы данных MariaDB в 03:40
  # --------------------------------------------------------------------------
  - id: "779498b6-e63f-454d-8866-8e7e7a94d8e4"
    alias: "MariaDB: Очистка базы в 3:40"
    description: >
      Каждый день в 03:40 запускаем recorder.purge,
      оставляя историю только за последние 90 дней.
    mode: single
    triggers:
      - trigger: time
        at: "03:40:00"
    actions:
      - action: recorder.purge
        data:
          keep_days: 90
      - action: script.log_helper_event
        data:
          level: info
          message: "MariaDB: очистка истории завершена."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.entity_id | default('') }}"
          trigger_from: "{{ trigger.from_state.state | default('') }}"
          trigger_to: "{{ trigger.to_state.state | default('') }}"
          extra: "keep_days=90"

  ##############################################################################
  # Выключение света, отпаривателя и ТВ в рабочие дни
  ##############################################################################
  - id: "8a46561c-f48f-4c93-b53e-d1af940fdb6d"
    alias: "Рабочие дни: Выключение света, отпаривателя и ТВ (09:00-17:00)"
    description: >
      В будни с 09:00 до 17:00, если никого нет дома и не идёт уборка,
      выключаем свет, отпариватель и ТВ.
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.someone_is_home_2
        to: "off"
      - trigger: time
        at: "09:00:00"
    conditions:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: time
        after: "09:00:00"
        before: "17:00:00"
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
      - condition: state
        entity_id: binary_sensor.someone_is_home_2
        state: "off"
    actions:
      # Сначала проверяем, что ключевой сенсор в адекватном состоянии
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ states('binary_sensor.someone_is_home_2') in ['unknown', 'unavailable'] }}
            sequence:
              - action: script.log_helper_event
                data:
                  level: error
                  message: >
                    binary_sensor.someone_is_home_2 имеет состояние
                    '{{ states("binary_sensor.someone_is_home_2") }}', автоматика прервана.
                  source: "{{ this.entity_id }}"
                  trigger_entity: "{{ trigger.entity_id | default('') }}"
                  trigger_from: "{{ trigger.from_state.state | default('') }}"
                  trigger_to: "{{ trigger.to_state.state | default('') }}"
                  extra: "reason=invalid_presence_sensor_state"
              - stop: "Сенсор присутствия недоступен, дальнейшие действия не выполняются."
        default:
          - action: homeassistant.turn_off
            target:
              entity_id: light.all_lights
          - action: switch.turn_off
            target:
              entity_id: switch.smart_plug_in_unit_vykliuchatel
          - action: homeassistant.turn_off
            target:
              entity_id: group.living_room_tv
          - action: script.log_helper_event
            data:
              level: info
              message: >
                Рабочие дни: свет, отпариватель и ТВ выключены
                (никого нет дома в рабочее время).
              source: "{{ this.entity_id }}"
              trigger_entity: "{{ trigger.entity_id | default('') }}"
              trigger_from: "{{ trigger.from_state.state | default('') }}"
              trigger_to: "{{ trigger.to_state.state | default('') }}"
              extra: "action=workday_poweroff"

  ################################################################################
  # Отключение отпаривателя при отсутствии дома
  ################################################################################
  - id: "ee320693-2e76-435b-8012-3a908046d4d"
    alias: "Выключение отпаривателя при отсутствии дома"
    description: >
      Выключает розетку отпаривателя при уходе всех жильцов.
      Безопасность: предотвращает работу устройства без присмотра.
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.someone_is_home_2
        to: "off"
    actions:
      - action: switch.turn_off
        target:
          entity_id: switch.smart_plug_in_unit_vykliuchatel
      - action: script.log_helper_event
        data:
          level: info
          message: "Отпариватель выключен, так как никого нет дома."
          source: "{{ this.entity_id }}"
          trigger_entity: "{{ trigger.entity_id | default('') }}"
          trigger_from: "{{ trigger.from_state.state | default('') }}"
          trigger_to: "{{ trigger.to_state.state | default('') }}"
          extra: "action=steamer_off_on_away"

  ################################################################################
  # Сброс флагов стирки при старте HA
  ################################################################################
  - id: "76238992-89bc-48c6-bd82-27e8a7c79b6d"
    alias: "HELPER: Сброс флагов стирки при старте HA"
    mode: single
    triggers:
      - trigger: homeassistant
        event: start
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.wm_cycle_seen_start
            - input_boolean.washing_machine_running
            - input_boolean.wm_socket_outage_active
      - action: script.log_helper_event
        data:
          level: info
          message: >
            Сброс флагов стирки при старте HA:
            wm_cycle_seen_start, washing_machine_running, wm_socket_outage_active = OFF.
          source: "{{ this.entity_id }}"
          trigger_entity: "homeassistant.start"
          trigger_from: ""
          trigger_to: ""
          extra: "action=reset_wm_flags"
