################################################################################
# /packages/telegram_notifications.yaml
################################################################################
#
# –≠—Ç–æ—Ç –ø–∞–∫–µ—Ç Home Assistant —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
# —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# –æ —Å–æ–±—ã—Ç–∏—è—Ö –≤ ¬´—É–º–Ω–æ–º –¥–æ–º–µ¬ª. –û–Ω –≤–∫–ª—é—á–∞–µ—Ç:
#
# –°–∫—Ä–∏–ø—Ç—ã:
#    ‚Ä¢ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã
#
# –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏:
#    ‚Ä¢ –ó–∞–ø—É—Å–∫–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–∏ Home Assistant.
#    ‚Ä¢ –û—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏ –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞.
#    ‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑–µ –ø–æ–≥–æ–¥—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.
#    ‚Ä¢ –ó–≤–æ–Ω–∫–µ –≤ –¥–≤–µ—Ä—å.
#    ‚Ä¢ –í–∫–ª—é—á–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã (–≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è/–¥–Ω–∏).
#    ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ç–∏—Ä–∫–∏.
#    ‚Ä¢ –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ç—Ä–∏—Ç—å –ø–æ–º–µ—â–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º CO2.
#    ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞–Ω–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω—è CO2.
#    ‚Ä¢ –ü–æ–Ω–∏–∂–µ–Ω–∏–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≤ –ø–æ–º–µ—â–µ–Ω–∏—è—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–≤–µ—Ä–∏/–æ–∫–Ω–µ.
#    ‚Ä¢ –ù–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ –∑–∞—Ä—è–¥–∞ –±–∞—Ç–∞—Ä–µ–π –≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (—Å –ø–æ–º–æ—â—å—é blueprint).
#    ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤/–ø–ª–∞–≥–∏–Ω–æ–≤.
#    ‚Ä¢ –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞ –≤ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–µ.
#
################################################################################

##############################################################################
#                                  –°–ö–†–ò–ü–¢–´
##############################################################################

# ----------------------------------------------------------------------------
# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã
# ----------------------------------------------------------------------------

script:
  telegram_send_weather_forecast:
    description: "–§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é"
    fields:
      recipient:
        description: "–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, notify.master)"
        example: "notify.master"
        required: true
    sequence:
      # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
      - service: weather.get_forecasts
        data:
          type: hourly # –∏–ª–∏ daily, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ
        target:
          entity_id: weather.kvartira_133
        response_variable: weather_forecast

      - variables:
          today_date: "{{ now().strftime('%d.%m.%Y') }}"
          title: "<b>–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –Ω–∞ <u>{{ today_date }}</u></b>"

          # –¢–µ–∫—É—â–∏–µ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
          current_condition: "{{ states('sensor.open_meteo_opisanie_na_russkom') | default(states('weather.kvartira_133')) }}"
          current_temperature: "{{ state_attr('weather.kvartira_133', 'temperature') | default('N/A') }}"
          current_wind_bearing: "{{ state_attr('weather.kvartira_133', 'wind_bearing') | default(0) }}"
          current_wind_speed: "{{ state_attr('weather.kvartira_133', 'wind_speed') | default('N/A') }}"
          current_pressure_mmhg: "{{ state_attr('weather.kvartira_133', 'pressure') | default(0) }}"

          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞ –≤ —Ç–µ–∫—Å—Ç
          wind_direction: >-
            {% set bearing = current_wind_bearing | int %}
            {% if bearing >= 337.5 or bearing < 22.5 %}—Å–µ–≤–µ—Ä–Ω—ã–π
            {% elif bearing >= 22.5 and bearing < 67.5 %}—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π
            {% elif bearing >= 67.5 and bearing < 112.5 %}–≤–æ—Å—Ç–æ—á–Ω—ã–π
            {% elif bearing >= 112.5 and bearing < 157.5 %}—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π
            {% elif bearing >= 157.5 and bearing < 202.5 %}—é–∂–Ω—ã–π
            {% elif bearing >= 202.5 and bearing < 247.5 %}—é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π
            {% elif bearing >= 247.5 and bearing < 292.5 %}–∑–∞–ø–∞–¥–Ω—ã–π
            {% elif bearing >= 292.5 and bearing < 337.5 %}—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π
            {% else %}–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ{% endif %}

          # –ë–µ—Ä—ë–º —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–µ–Ω—Å–æ—Ä–∞ –∏–ª–∏ –∏–∑ weather entity
          current_pressure: >-
            {% set sensor_pressure = states('sensor.livingroom_corrected_pressure') | float(0) %}
            {% if sensor_pressure > 0 %}
              {{ sensor_pressure | round(1) }}
            {% elif current_pressure_mmhg > 0 %}
              {{ current_pressure_mmhg | round(1) }}
            {% else %}
              735
            {% endif %}

          # –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
          weather_icon: >-
            {% set cond = states('weather.kvartira_133') %}
            {% if cond == 'sunny' or current_condition == '—è—Å–Ω–æ' %}‚òÄÔ∏è
            {% elif cond == 'partlycloudy' or current_condition == '–º–∞–ª–æ–æ–±–ª–∞—á–Ω–æ' %}‚õÖ
            {% elif cond == 'cloudy' or current_condition in ['–æ–±–ª–∞—á–Ω–æ —Å –ø—Ä–æ—è—Å–Ω–µ–Ω–∏—è–º–∏', '–æ–±–ª–∞—á–Ω–æ'] %}‚òÅÔ∏è
            {% elif cond == 'overcast' or current_condition == '–ø–∞—Å–º—É—Ä–Ω–æ' %}üå•
            {% elif cond == 'fog' or current_condition == '—Ç—É–º–∞–Ω' %}üå´
            {% elif cond in ['drizzle','light-rain'] or current_condition in ['–º–æ—Ä–æ—Å—å', '–Ω–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å'] %}üå¶
            {% elif cond in ['rainy','rain'] or current_condition == '–¥–æ–∂–¥–ª–∏–≤–æ' %}üåß
            {% elif cond == 'pouring' or current_condition == '–ª–∏–≤–µ–Ω—å' %}‚õà
            {% elif cond == 'snowy' or current_condition == '—Å–Ω–µ–≥' %}‚ùÑÔ∏è
            {% elif cond == 'snowy-heavy' or current_condition == '—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥' %}üå®
            {% elif cond == 'sleet' or current_condition == '–¥–æ–∂–¥—å —Å–æ —Å–Ω–µ–≥–æ–º' %}üåß‚ùÑÔ∏è
            {% elif cond == 'lightning' or current_condition == '–≥—Ä–æ–∑–∞' %}‚ö°
            {% else %}üåà{% endif %}

      # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      - service: "{{ recipient }}"
        data:
          title: "{{ title }}"
          message: >-
            {{ weather_icon }} <b>–°–µ–π—á–∞—Å:</b> {{ current_condition }}

            üå° <b>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</b> {{ current_temperature }}¬∞C
            üå¨ <b>–í–µ—Ç–µ—Ä:</b> {{ wind_direction }}, {{ current_wind_speed }} –º/—Å

            <b>üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:</b>
            {%- if weather_forecast is defined and weather_forecast['weather.kvartira_133'] is defined and weather_forecast['weather.kvartira_133']['forecast'] is defined %}
            {%- set forecasts = weather_forecast['weather.kvartira_133']['forecast'] %}
            {%- set today_items = namespace(found=false) %}
            {%- for forecast in forecasts[:8] %}
            {%- if forecast.datetime is defined %}
            {%- set forecast_dt = forecast.datetime | as_datetime | as_local %}
            {%- if forecast_dt is not none and forecast_dt.date() == now().date() and forecast_dt > now() %}
            {%- set today_items.found = true %}
            {%- set cond = forecast.condition | default('unknown') %}
            {%- set icon = '‚òÄÔ∏è' if cond == 'sunny' else '‚õÖ' if cond == 'partlycloudy' else '‚òÅÔ∏è' if cond == 'cloudy' else 'üå•' if cond == 'overcast' else 'üå´' if cond == 'fog' else 'üå¶' if cond in ['drizzle','light-rain'] else 'üåß' if cond in ['rainy','rain'] else '‚õà' if cond == 'pouring' else '‚ùÑÔ∏è' if cond == 'snowy' else 'üå®' if cond == 'snowy-heavy' else 'üåß‚ùÑÔ∏è' if cond == 'sleet' else '‚ö°' if cond == 'lightning' else 'üåà' %}
            ‚Ä¢ <b>{{ forecast_dt.strftime('%H:%M') }}</b> {{ icon }} {{ forecast.temperature | round(1) }}¬∞C
            {%- set precip = forecast.precipitation | float(0) if forecast.precipitation is defined else 0 -%}
            {%- if precip > 0 %}, –æ—Å–∞–¥–∫–∏: {{ precip }} –º–º{% endif -%}
            {%- endif -%}
            {%- endif -%}
            {%- endfor %}
            {%- if not today_items.found %}
            ‚ÑπÔ∏è –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å—Ç–∞–≤—à—É—é—Å—è —á–∞—Å—Ç—å –¥–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            {%- endif -%}
            {%- else %}
            ‚ö†Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –ø–æ–≥–æ–¥—ã)
            {%- endif %}

            <b>üí® –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ:</b> {{ current_pressure }} –º–º —Ä—Ç. —Å—Ç.
            (<i>{% if current_pressure > 740 %}‚¨ÜÔ∏è –≤—ã—à–µ –Ω–æ—Ä–º—ã{% elif current_pressure < 738 %}‚¨áÔ∏è –Ω–∏–∂–µ –Ω–æ—Ä–º—ã{% else %}üü¢ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ{% endif %}</i>)

##############################################################################
#                             –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò
##############################################################################
automation:
  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã
  # ----------------------------------------------------------------------------
  - id: "ac0837cf-9ecb-413b-96fb-89552934212d"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã"
    description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –≤ –¢–µ–ª–µ–≥—Ä–∞–º –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ."
    mode: single
    triggers:
      - trigger: time
        at: "07:45:00"
    actions:
      - action: script.telegram_send_weather_forecast
        data:
          recipient: notify.master

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –û—Ç–∫—Ä—ã—Ç–∏–µ –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏
  # ----------------------------------------------------------------------------
  - id: "1f7e3ae4-268e-4afa-a7e6-d395821f244b"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –û—Ç–∫—Ä—ã—Ç–∏–µ –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏"
    description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏, –µ—Å–ª–∏ master –Ω–µ –¥–æ–º–∞ –∏ —Ä–µ–∂–∏–º —É–±–æ—Ä–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω."
    mode: single
    triggers:
      - trigger: device
        device_id: abd3e40b49cfbe61411bac5d87bf000f
        entity_id: binary_sensor.hallway_door_contact
        domain: binary_sensor
        type: opened
    conditions:
      - condition: state
        entity_id: person.master
        state: "not_home"
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
    actions:
      - action: notify.master
        data:
          message: "‚ö†Ô∏è <b>–û—Ç–∫—Ä—ã—Ç–∏–µ –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏!</b> üîì"

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –ó–≤–æ–Ω–æ–∫ –≤ –¥–≤–µ—Ä—å
  # ----------------------------------------------------------------------------
  - id: "eaddf6dd-762d-487e-9bf2-ba018f10b742"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ –≤ –¥–≤–µ—Ä—å"
    mode: single
    triggers:
      - trigger: device
        domain: mqtt
        device_id: d2c3001cdc59660c456de45aec09da91
        type: action
        subtype: single
      - trigger: state
        entity_id: event.madv_cn_329651133_miowlv2l_doorbell_ring_e_2_1
    conditions:
      - condition: state
        entity_id: person.master
        state: "not_home"
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.doorbell_spam_guard
        state: "off"
    actions:
      - action: notify.master
        data:
          message: "‚ö†Ô∏è <b>–ö—Ç–æ-—Ç–æ –∑–≤–æ–Ω–∏—Ç –≤ –¥–≤–µ—Ä—å</b>"
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.doorbell_spam_guard
      - delay: "00:00:30"
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.doorbell_spam_guard

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
  # ----------------------------------------------------------------------------
  - id: "686a3440-7629-4b55-b508-593caf3679af"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
    description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞"
    mode: single
    triggers:
      - trigger: homeassistant
        event: start
    actions:
      - action: notify.master
        data:
          message: >
            {{ ["Home assistant started!", "Home assistant is running now!", "Home assistant has begun!", "HA has started!"] | random }}
          data:
            photo:
              - file: "/config/www/images/notify_alert/ha_wakeup.png"
                caption: "{{ ['Home assistant started!', 'Home assistant is running now!', 'Home assistant has begun!', 'HA has started!'] | random }}"

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª—é—á—ë–Ω
  # ----------------------------------------------------------------------------
  - id: "c8dc47aa-90f0-4522-b71e-4e99bbfe6c76"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª—é—á—ë–Ω"
    description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞"
    mode: single
    triggers:
      - trigger: homeassistant
        event: shutdown
    actions:
      - action: notify.master
        data:
          message: >
            {{ ['Home Assistant shutdown', 'Shutdown of Home Assistant', 'HA has been shut down'] | random }}
          data:
            photo:
              - file: "/config/www/images/notify_alert/ha_shutdown.png"
                caption: "{{ ['Home Assistant shutdown', 'Shutdown of Home Assistant', 'HA has been shut down'] | random }}"

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –í–æ–∑–º–æ–∂–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  # ----------------------------------------------------------------------------
  - id: "4c5c8e57-be5b-4380-88a1-4ecc730c19da"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –í–æ–∑–º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å–∏—Å—Ç–µ–º—ã"
    description: "–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ Home Assistant"
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - update.file_editor_update
          - update.home_assistant_core_update
          - update.home_assistant_google_drive_backup_update
          - update.home_assistant_operating_system_update
          - update.home_assistant_supervisor_update
          - update.log_viewer_update
          - update.mosquitto_broker_update
          - update.studio_code_server_update
          - update.advanced_ssh_web_terminal_update
          - update.zigbee2mqtt_update
          - update.ps5_mqtt_update
        to: "on"
    actions:
      - action: notify.master
        data:
          message: >
            {% set entity = trigger.to_state %}
            {% if entity %}
              üÜï –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ: {{ entity.attributes.friendly_name | default('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç') }}
              –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: {{ entity.attributes.installed_version | default('–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ') }}
              –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: {{ entity.attributes.latest_version | default('–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ') }}
              üìù –°–≤–æ–¥–∫–∞: {{ entity.attributes.release_summary | default('–ù–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π') }}
            {% else %}
              –û—à–∏–±–∫–∞: –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
            {% endif %}

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏ –º–∞—Å—Å–∞–∂—ë—Ä–∞
  # ----------------------------------------------------------------------------
  - id: "ab45665b-4995-448d-b180-c0e1d77184e9"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏ –º–∞—Å—Å–∞–∂—ë—Ä–∞"
    mode: single
    triggers:
      - trigger: numeric_state
        entity_id: sensor.soocare_cn_1083009681_m14_battery_level_p_3_1
        below: 30
    conditions:
      - condition: state
        entity_id: person.master
        state: "home"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    actions:
      - action: notify.master
        data:
          message: "‚ö†Ô∏è <b>–ú–∞—Å—Å–∞–∂—ë—Ä –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –∑–∞—Ä—è–¥–∫–µ!</b>"

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –ü—Ä–æ–±–ª–µ–º—ã —Å –∂–µ—Å—Ç–∫–∏–º–∏ –¥–∏—Å–∫–∞–º–∏ Proxmox
  # ----------------------------------------------------------------------------
  - id: "daa17acf-7c8a-4a8e-9fd0-4f2c5348c814"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –ü—Ä–æ–±–ª–µ–º—ã —Å –∂–µ—Å—Ç–∫–∏–º–∏ –¥–∏—Å–∫–∞–º–∏ Proxmox"
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.disk_pve_h_w_raid1_dev_sdb_health
        to: "on"
      - trigger: state
        entity_id: binary_sensor.disk_pve_128gb_ssd_dev_sda_health
        to: "on"
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    actions:
      - action: notify.master
        data:
          message: >-
            ‚ö†Ô∏è <b>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∂–µ—Å—Ç–∫–∏–º –¥–∏—Å–∫–æ–º Proxmox!</b>
            {% if trigger.entity_id == 'binary_sensor.disk_pve_h_w_raid1_dev_sdb_health' %}
            üî¥ –í–Ω–µ—à–Ω–∏–π RAID –º–∞—Å—Å–∏–≤ (sdb) —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è!
            {% elif trigger.entity_id == 'binary_sensor.disk_pve_128gb_ssd_dev_sda_health' %}
            üî¥ –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Å–∫ —Å–∏—Å—Ç–µ–º—ã (sda) —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è!
            {% endif %}

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∏—Å–∫–∞ Proxmox
  # ----------------------------------------------------------------------------
  - id: "4751a90b-0134-4906-84f0-e5b1a7cb02c2"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∏—Å–∫–∞ Proxmox"
    mode: single
    triggers:
      - trigger: numeric_state
        entity_id: sensor.node_pve_disk_used_percentage
        above: 90
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    actions:
      - action: notify.master
        data:
          message: >-
            ‚ö†Ô∏è <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∏—Å–∫–∞ –Ω–∞ Proxmox!</b>
            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: {{ states('sensor.node_pve_disk_used_percentage') }}%.

  # ----------------------------------------------------------------------------
  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –î–æ—Å—Ç—É–ø–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è Proxmox
  # ----------------------------------------------------------------------------
  - id: "ab5c1bd2-8756-4736-9909-52766bf989bd"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –î–æ—Å—Ç—É–ø–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è Proxmox"
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.node_pve_updates_packages
        to: "on"
    conditions:
      - condition: state
        entity_id: person.master
        state: "home"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    actions:
      - action: notify.master
        data:
          message: >-
            üîÑ <b>–î–æ—Å—Ç—É–ø–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è Proxmox!</b>
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {{ states('sensor.node_pve_total_updates') | default(0) }}.
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º—É –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

  # ----------------------------------------------------------------------------
  # –¢–µ–ª–µ–≥—Ä–∞–º: –°–µ–π—Ñ ‚Äî —Ä–∏—Å–∫ –ø–ª–µ—Å–µ–Ω–∏ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π)
  # ----------------------------------------------------------------------------
  - id: "666e2076-ea49-4c53-85de-ef23566b5d00"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –°–µ–π—Ñ ‚Äî —Ä–∏—Å–∫ –ø–ª–µ—Å–µ–Ω–∏"
    mode: single
    triggers:
      - trigger: state
        entity_id: input_boolean.strongbox_hum_text_notified
        to: "on"
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    actions:
      - variables:
          rh: "{{ states('sensor.strongbox_th_humidity') | float(0) | round(1) }}"
          t: "{{ states('sensor.strongbox_th_temperature') | float(0) | round(1) }}"
          dp: "{{ states('sensor.seif_tochka_rosy_c') | default(states('sensor.strongbox_th_temperature')) | float(0) | round(1) }}"
          ah: "{{ states('sensor.seif_absolyutnaya_vlazhnost_g_m3') | default(0) | float(0) | round(2) }}"
      - action: notify.master
        data:
          message: >-
            ‚ö†Ô∏è <b>–°–µ–π—Ñ: —Ä–∏—Å–∫ –ø–ª–µ—Å–µ–Ω–∏</b>
            –í–ª–∞–∂–Ω–æ—Å—Ç—å: <b>{{ rh }}%</b>, –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: <b>{{ t }}¬∞C</b>
            –¢–æ—á–∫–∞ —Ä–æ—Å—ã: <b>{{ dp }}¬∞C</b>, –ê–±—Å. –≤–ª–∞–∂–Ω.: <b>{{ ah }} –≥/–º¬≥</b>

            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
            ‚Ä¢ –ü–æ–ª–æ–∂–∏—Ç–µ –≤–ª–∞–≥–æ–ø–æ–≥–ª–æ—Ç–∏—Ç–µ–ª—å (—Å–∏–ª–∏–∫–∞–≥–µ–ª—å) –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –ø–∞–∫–µ—Ç.
            ‚Ä¢ –ü—Ä–æ–≤–µ—Ç—Ä–∏—Ç–µ —Å–µ–π—Ñ –∏ –ø–æ–º–µ—â–µ–Ω–∏–µ (–±–µ–∑ —Ä–µ–∑–∫–∏—Ö –ø–µ—Ä–µ–ø–∞–¥–æ–≤).
            ‚Ä¢ –°—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∫ RH 40‚Äì55% –∏ T ‚â• {{ states('input_number.strongbox_temp_min')|int }}¬∞C.

  # ----------------------------------------------------------------------------
  # –¢–µ–ª–µ–≥—Ä–∞–º: –°–µ–π—Ñ ‚Äî —É—Å–ª–æ–≤–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª–∏—Å—å
  # ----------------------------------------------------------------------------
  - id: "cba8ab8b-5849-423a-bc56-6c04bfb51699"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ª–µ–≥—Ä–∞–º: –°–µ–π—Ñ ‚Äî —É—Å–ª–æ–≤–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª–∏—Å—å"
    mode: single
    triggers:
      - trigger: state
        entity_id: input_boolean.strongbox_hum_text_notified
        to: "off"
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    actions:
      - variables:
          rh: "{{ states('sensor.strongbox_th_humidity') | float(0) | round(1) }}"
          t: "{{ states('sensor.strongbox_th_temperature') | float(0) | round(1) }}"
      - action: notify.master
        data:
          message: >-
            ‚úÖ <b>–°–µ–π—Ñ: —É—Å–ª–æ–≤–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã</b>
            –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è: RH <b>{{ rh }}%</b>, T <b>{{ t }}¬∞C</b>.

  # ----------------------------------------------------------------------------
  # –û—á–∏—Å—Ç–∏—Ç–µ–ª—å ‚Äî —Ñ–∏–ª—å—Ç—Ä <10%
  # ----------------------------------------------------------------------------
  - id: "d3bb27a3-51be-4ce6-8dc7-ebad482e5ea3"
    alias: "–¢–µ–ª–µ–≥—Ä–∞–º: –æ—á–∏—Å—Ç–∏—Ç–µ–ª—å ‚Äî —Ñ–∏–ª—å—Ç—Ä <10%"
    mode: single
    triggers:
      - trigger: numeric_state
        entity_id: sensor.zhimi_cn_271517251_mb3_filter_life_level_p_4_3
        below: 10
        for: "00:01:00"
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.air_filter_replace_notified
        state: "off"
    actions:
      - action: notify.master
        data:
          message: "‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç–µ–ª—å –≤–æ–∑–¥—É—Ö–∞: —Ä–µ—Å—É—Ä—Å —Ñ–∏–ª—å—Ç—Ä–∞ &lt; 10%."
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.air_filter_replace_notified

  # ----------------------------------------------------------------------------
  # –£–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å ‚Äî —Ñ–∏–ª—å—Ç—Ä <10%
  # ----------------------------------------------------------------------------
  - id: "dbaaf929-4f15-4b23-8d4b-b8edd4083484"
    alias: "–¢–µ–ª–µ–≥—Ä–∞–º: —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å ‚Äî —Ñ–∏–ª—å—Ç—Ä <10%"
    mode: single
    triggers:
      - trigger: numeric_state
        entity_id: sensor.xiaomi_cn_823407205_p3_filter_life_level_p_8_1
        below: 10
        for: "00:01:00"
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.humidifier_filter_replace_notified
        state: "off"
    actions:
      - action: notify.master
        data:
          message: "‚ö†Ô∏è –£–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å: —Ä–µ—Å—É—Ä—Å —Ñ–∏–ª—å—Ç—Ä–∞ &lt; 10%."
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.humidifier_filter_replace_notified

  # ----------------------------------------------------------------------------
  # –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã
  # ----------------------------------------------------------------------------
  - id: "68eb40de-2339-4260-9bd6-3db5aa1604d9"
    alias: "–¢–µ–ª–µ–≥—Ä–∞–º: —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å ‚Äî –Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã"
    mode: single
    triggers:
      - trigger: state
        entity_id: event.xiaomi_cn_823407205_p3_low_water_level_e_2_1
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.humidifier_low_water_notified
        state: "off"
    actions:
      - action: notify.master
        data:
          message: "üíß –£–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å: –Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–ª–µ–π—Ç–µ –≤–æ–¥—É."
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.humidifier_low_water_notified
