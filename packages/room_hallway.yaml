################################################################################
# /packages/room_hallway.yaml
################################################################################
#
# УПРАВЛЕНИЕ ПРИХОЖЕЙ И МОНИТОРИНГ СЕЙФА
#
# ФУНКЦИИ:
# 1. Интеллектуальное освещение прихожей
#    • Управление кнопкой (ручное включение/выключение)
#    • Автоматическое включение при открытии двери
#    • Датчик движения с учётом освещённости
#    • Таймер автовыключения (настраиваемый)
#    • "Окно прибытия" — умное включение света при возвращении домой
#
# 2. Уведомления
#    • Звонок в дверь — голосовое уведомление + мигание света
#    • Попытка снятия кнопки — TTS + Telegram
#
# 3. Мониторинг микроклимата сейфа (strongbox)
#    • Сглаживание показаний температуры и влажности (5 мин)
#    • Расчёт точки росы и абсолютной влажности
#    • Детекция риска плесени с гистерезисом
#    • Подтверждение риска/нормализации (защита от ложных срабатываний)
#    • Уведомления через Telegram
#
# УСТРОЙСТВА:
# • light.hallway_switch — основной свет прихожей
# • light.gateway_light_04cf8c977cdd — подсветка шлюза
# • binary_sensor.hallway_door_contact — датчик двери
# • binary_sensor.hallway_motion_ultrasonic_occupancy — датчик движения
# • sensor.illumination_04cf8c977cdd — датчик освещённости
# • sensor.strongbox_th_temperature — температура сейфа
# • sensor.strongbox_th_humidity — влажность сейфа
#
# ВЫКЛЮЧАТЕЛИ/КНОПКИ:
# • device_id: cfd464e1cbfa3da2ddd4f2109d74eb4e — кнопка в прихожей
# • device_id: d2c3001cdc59660c456de45aec09da91 — уличная кнопка (звонок)
#
# ЗАВИСИМОСТИ:
# • script.yandex_tts_click_outdoor_button — голосовое уведомление о звонке
# • script.yandex_tts_shaking_outdoor_button — уведомление о попытке снятия
# • notify.master — Telegram-уведомления
# • input_boolean.bathroom_cleaning_mode — режим уборки
#
# ЛОГИКА "ОКНА ПРИБЫТИЯ":
# ┌──────────────────────────────────────────────────────────────────┐
# │ Человек пришёл домой (person.master → home)                      │
# │ ↓                                                                │
# │ Сброс флага hallway_first_door_open                              │
# │ ↓                                                                │
# │ Запуск таймера "окна прибытия" (10 минут)                        │
# │ ↓                                                                │
# │ Первое открытие двери в течение 10 минут                         │
# │ ↓                                                                │
# │ Включение полного освещения (100% яркость)                       │
# │ ↓                                                                │
# │ Установка флага hallway_first_door_open = on                     │
# │ ↓                                                                │
# │ Отмена таймера "окна прибытия"                                   │
# └──────────────────────────────────────────────────────────────────┘
#
# ЛОГИКА МОНИТОРИНГА СЕЙФА:
# ┌──────────────────────────────────────────────────────────────────┐
# │ Сглаживание T/RH (5 мин) → Расчёт точки росы                     │
# │ ↓                                                                │
# │ Условия риска: RH ≥ 65% ИЛИ (T - точка_росы) ≤ 1°C              │
# │ ↓                                                                │
# │ Подтверждение риска (10 мин устойчиво)                           │
# │ ↓                                                                │
# │ Флаг strongbox_hum_text_notified = on → Telegram                 │
# │ ↓                                                                │
# │ Нормализация: RH ≤ 55% И T ≥ 15°C (20 мин устойчиво)            │
# │ ↓                                                                │
# │ Флаг strongbox_hum_text_notified = off → Telegram                │
# └──────────────────────────────────────────────────────────────────┘
#
################################################################################

##############################################################################
#                        НАСТРАИВАЕМЫЕ ПАРАМЕТРЫ
##############################################################################

input_number:
  # ==========================================================================
  # ОСВЕЩЕНИЕ ПРИХОЖЕЙ
  # ==========================================================================

  hallway_timer_duration:
    name: "Прихожая: длительность таймера (мин)"
    min: 1
    max: 5
    step: 0.5
    initial: 1.5
    icon: mdi:timer

  hallway_blink_count:
    name: "Прихожая: количество миганий при звонке"
    min: 1
    max: 5
    step: 1
    initial: 3
    icon: mdi:lightbulb-multiple

  # ==========================================================================
  # СЕЙФ: ПОРОГИ МИКРОКЛИМАТА
  # ==========================================================================

  strongbox_humidity_high:
    name: "Сейф: порог влажности ВКЛ (%)"
    min: 50
    max: 85
    step: 1
    initial: 65
    icon: mdi:water-percent-alert

  strongbox_humidity_low:
    name: "Сейф: порог влажности ВЫКЛ (%)"
    min: 40
    max: 80
    step: 1
    initial: 55
    icon: mdi:water-percent

  strongbox_temp_min:
    name: "Сейф: минимальная температура (°C)"
    min: 5
    max: 25
    step: 0.5
    initial: 15
    icon: mdi:thermometer-low

  # ==========================================================================
  # СЕЙФ: ВРЕМЕНА ПОДТВЕРЖДЕНИЯ
  # ==========================================================================

  strongbox_confirm_min:
    name: "Сейф: подтверждение риска (мин)"
    min: 1
    max: 60
    step: 1
    initial: 10
    icon: mdi:timer-alert

  strongbox_resolve_min:
    name: "Сейф: подтверждение нормализации (мин)"
    min: 1
    max: 120
    step: 1
    initial: 20
    icon: mdi:timer-check

##############################################################################
#                          INPUT BOOLEAN
##############################################################################

input_boolean:
  # Флаг первого открытия двери после прибытия домой
  hallway_first_door_open:
    name: "Прихожая: первое открытие двери"
    initial: off
    icon: mdi:door-open

  # Флаг уведомления о микроклимате сейфа
  strongbox_hum_text_notified:
    name: "Сейф: уведомление отправлено"
    initial: off
    icon: mdi:message-alert

##############################################################################
#                               ТАЙМЕРЫ
##############################################################################

timer:
  # ==========================================================================
  # Таймер автовыключения света в прихожей
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Автоматическое выключение света после отсутствия движения
  # • Запускается при выключении датчика движения
  # • Перезапускается при новом движении (продление освещения)
  #
  # ДЛИТЕЛЬНОСТЬ:
  # • По умолчанию: 1.5 минуты
  # • Настраивается через input_number.hallway_timer_duration
  # ==========================================================================
  timer_hallway:
    name: "Прихожая: таймер автовыключения"
    duration: "00:01:30" # Базовое значение; реальная длительность задаётся динамически
    icon: mdi:timer-off

  # ==========================================================================
  # Таймер "окна прибытия" после возвращения домой
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Активное окно после прихода домой (10 минут)
  # • При первом открытии двери в этом окне — полное освещение
  # • После срабатывания или окончания 10 минут — окно закрывается
  #
  # ДЛИТЕЛЬНОСТЬ:
  # • Фиксированная: 10 минут
  # • При необходимости можно вынести в input_number
  # ==========================================================================
  timer_arrival_window:
    name: "Прихожая: окно прибытия домой"
    duration: "00:10:00"
    icon: mdi:home-import-outline

##############################################################################
#                          СГЛАЖЕННЫЕ СЕНСОРЫ
##############################################################################
# СЕЙФ: фильтрация показаний для устойчивых расчётов
# Скользящее среднее за 5 минут устраняет кратковременные скачки

sensor:
  # ==========================================================================
  # Сглаженная влажность сейфа (5 мин скользящее среднее)
  # ==========================================================================
  - platform: filter
    name: "Сейф: влажность (сглаженная)"
    unique_id: strongbox_humidity_smoothed
    entity_id: sensor.strongbox_th_humidity
    filters:
      - filter: time_simple_moving_average
        window_size: "00:05"
        precision: 1

  # ==========================================================================
  # Сглаженная температура сейфа (5 мин скользящее среднее)
  # ==========================================================================
  - platform: filter
    name: "Сейф: температура (сглаженная)"
    unique_id: strongbox_temperature_smoothed
    entity_id: sensor.strongbox_th_temperature
    filters:
      - filter: time_simple_moving_average
        window_size: "00:05"
        precision: 2

##############################################################################
#                          ВЫЧИСЛЯЕМЫЕ СЕНСОРЫ
##############################################################################

template:
  - sensor:
      # ======================================================================
      # Точка росы в сейфе (Dew Point)
      # ======================================================================
      # ФОРМУЛА:
      # • Используется приближение Magnus-Tetens
      # • DP = (b × γ) / (a - γ)
      # • где γ = ln(RH/100) + (a × T) / (b + T)
      # • константы: a = 17.62, b = 243.12
      #
      # НАЗНАЧЕНИЕ:
      # • Определение температуры, при которой начнётся конденсация
      # • Критический параметр для предотвращения плесени
      #
      # ПРИМЕР:
      # • T = 20°C, RH = 60% → DP ≈ 12°C
      # • Если поверхность холоднее 12°C — появится конденсат
      # ======================================================================
      - name: "Сейф: точка росы"
        unique_id: strongbox_dew_point_c
        state_class: measurement
        unit_of_measurement: "°C"
        icon: mdi:water-thermometer
        availability: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable',''] }}
        state: >-
          {% set T  = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% if RH <= 0 %}
            unknown
          {% else %}
            {# Константы формулы Magnus-Tetens #}
            {% set a, b = 17.62, 243.12 %}
            {# γ = ln(RH/100) + (a × T) / (b + T) #}
            {% set gamma = ((a * T) / (b + T)) + (RH / 100) | log %}
            {# DP = (b × γ) / (a - γ) #}
            {{ ((b * gamma) / (a - gamma)) | round(2) }}
          {% endif %}

      # ======================================================================
      # Абсолютная влажность в сейфе (г/м³)
      # ======================================================================
      # ФОРМУЛА:
      # • AH = 1324.95 × (RH/100) × exp(17.67×T/(T+243.5)) / (T+273.15)
      #
      # НАЗНАЧЕНИЕ:
      # • Показывает реальное количество воды в воздухе
      # • Не зависит от температуры (в отличие от относительной влажности)
      # • Полезно для оценки эффективности осушения
      #
      # ПРИМЕР:
      # • T = 20°C, RH = 60% → AH ≈ 10.4 г/м³
      # • Означает, что в каждом кубометре воздуха ~10.4 г воды
      # ======================================================================
      - name: "Сейф: абсолютная влажность"
        unique_id: strongbox_absolute_humidity_gm3
        unit_of_measurement: "г/м³"
        icon: mdi:water-opacity
        availability: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable',''] }}
        state: >-
          {% set T  = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% if RH <= 0 %}
            unknown
          {% else %}
            {# Число Эйлера (e) #}
            {% set e = 2.718281828459045 %}
            {# Экспонента насыщения паров #}
            {% set x = (17.67 * T) / (T + 243.5) %}
            {# Абсолютная влажность #}
            {{ (1324.95 * (RH / 100.0) * (e ** x) / (T + 273.15)) | round(2) }}
          {% endif %}

##############################################################################
#                          БИНАРНЫЕ СЕНСОРЫ
##############################################################################

binary_sensor:
  - platform: template
    sensors:
      # ======================================================================
      # Риск плесени в сейфе (с гистерезисом)
      # ======================================================================
      # УСЛОВИЯ РИСКА:
      # • Относительная влажность ≥ 65% (жёсткий порог)
      # • ИЛИ температура близка к точке росы (≤ 1°C разницы)
      #
      # ГИСТЕРЕЗИС:
      # • Включение (off → on): RH ≥ 65% ИЛИ близко к точке росы
      # • Выключение (on → off): RH < 55% И не близко к точке росы
      #
      # ЛОГИКА:
      # ┌─────────────────────────────────────────────┐
      # │ RH 65% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│ ← Включение
      # │                                             │
      # │ RH 60% - - - - - - - - - - - - - - - - - -│
      # │                                             │
      # │ RH 55% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│ ← Выключение
      # └─────────────────────────────────────────────┘
      #
      # ПРИМЕРЫ:
      # 1. RH = 70%, T = 20°C, DP = 14°C → РИСК (высокая влажность)
      # 2. RH = 50%, T = 16°C, DP = 15.5°C → РИСК (близко к точке росы)
      # 3. RH = 50%, T = 20°C, DP = 9°C → НОРМА
      # ======================================================================
      strongbox_mold_risk:
        unique_id: strongbox_mold_risk
        friendly_name: "Сейф: риск плесени"
        device_class: problem
        availability_template: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_dew_point_c') not in ['unknown','unavailable',''] }}
        value_template: >-
          {% set T   = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH  = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% set dp  = states('sensor.strongbox_dew_point_c')         | float(-100) %}
          {% set hi  = states('input_number.strongbox_humidity_high') | float(65) %}
          {% set lo  = states('input_number.strongbox_humidity_low')  | float(55) %}
          {% set was = is_state('binary_sensor.strongbox_mold_risk','on') %}

          {# Проверка близости к точке росы (опасная зона) #}
          {% set close_to_dp = (T - dp) <= 1.0 %}

          {# Гистерезис: разные пороги для включения и выключения #}
          {% if was %}
            {# Уже в режиме риска → выключаем только при RH < lo И далеко от точки росы #}
            {{ (RH >= lo and close_to_dp) }}
          {% else %}
            {# Норма → включаем при RH ≥ hi ИЛИ близко к точке росы #}
            {{ (RH >= hi or (RH >= lo and close_to_dp)) }}
          {% endif %}
        icon_template: >-
          {% if is_state('binary_sensor.strongbox_mold_risk', 'on') %}
            mdi:biohazard
          {% else %}
            mdi:shield-check
          {% endif %}

      # ======================================================================
      # Условия в сейфе в норме
      # ======================================================================
      # УСЛОВИЯ НОРМЫ:
      # • Влажность ≤ 55% (ниже порога выключения риска)
      # • Температура ≥ 15°C (минимальный комфортный порог)
      #
      # НАЗНАЧЕНИЕ:
      # • Триггер для сброса уведомления о риске
      # • Должен держаться устойчиво (20 мин) перед сбросом флага
      # ======================================================================
      strongbox_safe_status:
        unique_id: strongbox_safe_status
        friendly_name: "Сейф: условия в норме"
        device_class: safety
        availability_template: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable',''] }}
        value_template: >-
          {% set T    = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH   = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% set lo   = states('input_number.strongbox_humidity_low')   | float(55) %}
          {% set tmin = states('input_number.strongbox_temp_min')       | float(15) %}
          {{ RH <= lo and T >= tmin }}
        icon_template: >-
          {% if is_state('binary_sensor.strongbox_safe_status', 'on') %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}

##############################################################################
#                             АВТОМАТИЗАЦИИ
##############################################################################

automation:
  # ==========================================================================
  # ОСВЕЩЕНИЕ ПРИХОЖЕЙ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Ручное управление светом кнопкой
  # --------------------------------------------------------------------------
  - id: "fc57ec27-9c9d-489a-8f5f-050b489466f7"
    alias: "Прихожая: переключение света кнопкой"
    description: >
      Переключает свет по нажатию кнопки.

      ТРИГГЕР:
      • Кнопка в прихожей (device_id: cfd464e1cbfa3da2ddd4f2109d74eb4e)
      • Одиночное нажатие (single)

      ДЕЙСТВИЯ:
      1. Переключение света (toggle)
      2. Если свет включился → запуск таймера автовыключения
      3. Если свет выключился → отмена таймера

      РЕЖИМ:
      • restart — новое нажатие прерывает предыдущее действие

      ЛОГИКА ТАЙМЕРА:
      • Свет ВКЛ → таймер запущен (автовыключение через N минут)
      • Свет ВЫКЛ → таймер отменён (не нужен)
    mode: restart
    trigger:
      - platform: device
        domain: mqtt
        device_id: cfd464e1cbfa3da2ddd4f2109d74eb4e
        type: action
        subtype: single
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    action:
      # Переключаем свет
      - type: toggle
        device_id: 61c0ac07893316543e261176eb0cb5f9
        entity_id: 89add52cab26b9b6bcad7e86fd6387ec
        domain: light

      # Управление таймером в зависимости от состояния света
      - choose:
          # Если хотя бы один источник света включён → запускаем таймер
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: light.hallway_switch
                    state: "on"
                  - condition: state
                    entity_id: light.gateway_light_04cf8c977cdd
                    state: "on"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.timer_hallway
                data:
                  duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"
        default:
          # Весь свет выключен → отменяем таймер
          - service: timer.cancel
            target:
              entity_id: timer.timer_hallway

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: свет переключён кнопкой."
          level: info

  # --------------------------------------------------------------------------
  # Автоматическое включение света при открытии двери
  # --------------------------------------------------------------------------
  - id: "3c9a07a9-58ee-4287-87ee-734687c93bba"
    alias: "Прихожая: включение света при открытии двери"
    description: >
      Автоматически включает свет при открытии двери.

      ТРИГГЕР:
      • Дверь открыта устойчиво 5 секунд (защита от ложных срабатываний)

      УСЛОВИЯ (ВСЕ ДОЛЖНЫ БЫТЬ ВЫПОЛНЕНЫ):
      • Свет выключен (не дублируем включение)
      • Время: 08:30 - 23:00 (дневной режим)
      • Фаза запуска завершена
      • Датчик двери доступен

      ДЕЙСТВИЯ:
      1. Включение основного света
      2. Запуск таймера автовыключения

      ВРЕМЕННОЕ ОКНО:
      • 08:30 - 23:00 — автоматическое включение работает
      • Ночью (23:00 - 08:30) — света не будет (не будит людей)

      ЗАДЕРЖКА 5 СЕКУНД:
      • Защита от кратковременных открытий
      • Подтверждение намерения войти
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_door_contact
        to: "on"
        for:
          seconds: 5 # Устойчивое открытие 5 секунд
    condition:
      - condition: state
        entity_id: light.hallway_switch
        state: "off"
      - condition: time
        after: "08:30:00"
        before: "23:00:00"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: template
        value_template: "{{ states('binary_sensor.hallway_door_contact') not in ['unknown','unavailable',''] }}"
    action:
      # Включаем основной свет
      - service: light.turn_on
        target:
          entity_id: light.hallway_switch

      # Запускаем таймер автовыключения
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: свет включён при открытии двери."
          level: info

  # --------------------------------------------------------------------------
  # Включение подсветки при движении и низкой освещённости
  # --------------------------------------------------------------------------
  - id: "7f815fb8-98f4-437a-96fc-06984d9a4a25"
    alias: "Прихожая: подсветка при движении и низкой освещённости"
    description: >
      Включает подсветку шлюза при движении в тёмное время.

      ТРИГГЕР:
      • Движение обнаружено устойчиво 10 секунд

      УСЛОВИЯ:
      • Освещённость < 250 lux (тёмно)
      • Фаза запуска завершена
      • Датчик движения доступен

      ДЕЙСТВИЯ:
      1. Включение подсветки шлюза (7% яркости)
      2. Запуск таймера автовыключения

      НИЗКАЯ ЯРКОСТЬ:
      • 7% — достаточно для ориентации, не слепит
      • Комфортный мягкий свет для навигации

      ЗАДЕРЖКА 10 СЕКУНД:
      • Защита от случайных срабатываний
      • Подтверждение присутствия человека
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "on"
        # for:
        #   seconds: 1
    condition:
      - condition: numeric_state
        entity_id: sensor.illumination_04cf8c977cdd
        below: 250
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: template
        value_template: "{{ states('binary_sensor.hallway_motion_ultrasonic_occupancy') not in ['unknown','unavailable',''] }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.someone_is_home_2
            state: "on"
          - condition: state
            entity_id: input_boolean.bathroom_cleaning_mode
            state: "on"
    action:
      # Включаем подсветку шлюза с низкой яркостью
      - service: light.turn_on
        target:
          entity_id: light.gateway_light_04cf8c977cdd
        data:
          brightness_pct: 7

      # Запускаем таймер автовыключения
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: подсветка включена при движении (низкая освещённость)."
          level: info

  # --------------------------------------------------------------------------
  # Запуск таймера при отсутствии движения
  # --------------------------------------------------------------------------
  - id: "3b6e37de-3b10-4201-afad-221dbe4cd4a0"
    alias: "Прихожая: запуск таймера при отсутствии движения"
    description: >
      Запускает таймер автовыключения, когда движение прекратилось.

      ТРИГГЕР:
      • Движение прекратилось устойчиво 10 секунд

      УСЛОВИЯ:
      • Хотя бы один источник света включён
      • Режим уборки выключен (в режиме уборки свет не выключается)
      • Фаза запуска завершена

      ДЕЙСТВИЯ:
      • Запуск таймера автовыключения

      РЕЖИМ УБОРКИ:
      • При включённом bathroom_cleaning_mode свет НЕ выключается автоматически
      • Позволяет убирать без постоянного срабатывания датчика движения

      ЗАДЕРЖКА 10 СЕКУНД:
      • Подтверждение отсутствия движения
      • Защита от ложных срабатываний
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "off"
        # for:
        #   seconds: 1
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: light.hallway_switch
            state: "on"
          - condition: state
            entity_id: light.gateway_light_04cf8c977cdd
            state: "on"
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    action:
      # Запускаем таймер автовыключения
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: таймер запущен (отсутствие движения)."
          level: info

  # --------------------------------------------------------------------------
  # Перезапуск таймера при обнаружении движения
  # --------------------------------------------------------------------------
  - id: "479b917d-e4c2-4149-97e7-d12779b9f3ce"
    alias: "Прихожая: перезапуск таймера при движении"
    description: >
      Продлевает освещение при новом движении.

      ТРИГГЕР:
      • Движение обнаружено устойчиво 5 секунд

      УСЛОВИЯ:
      • Хотя бы один источник света включён
      • Фаза запуска завершена

      ДЕЙСТВИЯ:
      1. Отмена текущего таймера
      2. Запуск нового таймера

      НАЗНАЧЕНИЕ:
      • Продление освещения при продолжающейся активности
      • Предотвращение выключения света во время использования прихожей

      ЛОГИКА:
      • Каждое новое движение "перезапускает часы"
      • Свет выключится только через N минут после последнего движения
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "on"
        for:
          seconds: 2

    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: light.hallway_switch
            state: "on"
          - condition: state
            entity_id: light.gateway_light_04cf8c977cdd
            state: "on"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.someone_is_home_2
            state: "on"
          - condition: state
            entity_id: input_boolean.bathroom_cleaning_mode
            state: "on"

    action:
      # Отменяем текущий таймер
      - service: timer.cancel
        target:
          entity_id: timer.timer_hallway

      # Запускаем новый таймер
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: таймер перезапущен (новое движение)."
          level: info

  # --------------------------------------------------------------------------
  # Выключение света по таймеру
  # --------------------------------------------------------------------------
  - id: "7f6bdbae-a73b-4509-8db8-43f71a3525ca"
    alias: "Прихожая: выключение света по таймеру"
    description: >
      Выключает свет после окончания таймера.

      ТРИГГЕР:
      • Событие: timer.finished (timer.timer_hallway)

      УСЛОВИЯ:
      • Режим уборки выключен

      ДЕЙСТВИЯ:
      • Выключение всего освещения прихожей

      ИСКЛЮЧЕНИЕ:
      • При включённом режиме уборки свет НЕ выключается
      • Позволяет убирать без помех от автоматики
    mode: single
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.timer_hallway
    condition:
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
    action:
      # Выключаем весь свет
      - service: light.turn_off
        target:
          entity_id:
            - light.hallway_switch
            - light.gateway_light_04cf8c977cdd

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: свет выключен по таймеру."
          level: info

  # ==========================================================================
  # "ОКНО ПРИБЫТИЯ" — УМНОЕ ВКЛЮЧЕНИЕ СВЕТА ПРИ ВОЗВРАЩЕНИИ ДОМОЙ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Первое попадание в прихожую после прибытия домой (дверь ИЛИ движение)
  # --------------------------------------------------------------------------
  - id: "first-door-home-automation"
    alias: "Прихожая: первое попадание в прихожую после прихода домой"
    description: >
      Включает полное освещение при первом появлении в прихожей
      после прибытия домой.

      ТРИГГЕРЫ:
      • Дверь открыта устойчиво 2 секунды
      • ИЛИ датчик присутствия в прихожей (ультразвуковой) = on устойчиво 2 секунды

      УСЛОВИЯ (ВСЕ ДОЛЖНЫ БЫТЬ ВЫПОЛНЕНЫ):
      • Флаг hallway_first_door_open = off (ещё не было первого входа)
      • person.master = home (человек дома)
      • Фаза запуска завершена
      • Таймер "окна прибытия" активен (в течение 10 минут после прихода)
      • ХОТЯ БЫ один из датчиков (дверь/движение) в валидном состоянии

      ДЕЙСТВИЯ:
      1. Включение основного света (100%)
      2. Включение подсветки шлюза (100%)
      3. Установка флага hallway_first_door_open = on
      4. Отмена таймера "окна прибытия"
      5. Запуск таймера автовыключения

      НАЗНАЧЕНИЕ:
      • Комфортное возвращение домой
      • Работает как по двери, так и по датчику присутствия
      • Срабатывает только ОДИН раз после прихода
    mode: single
    trigger:
      # Дверь: первое устойчивое открытие
      - platform: state
        entity_id: binary_sensor.hallway_door_contact
        to: "on"
        for:
          seconds: 2

      # Датчик присутствия: первое устойчивое появление
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "on"
        for:
          seconds: 2

    condition:
      # Ещё не было первого входа
      - condition: state
        entity_id: input_boolean.hallway_first_door_open
        state: "off"

      # Хозяин дома
      - condition: state
        entity_id: person.master
        state: "home"

      # Фаза запуска завершена
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"

      # Таймер "окна прибытия" активен (10 минут после прихода)
      - condition: state
        entity_id: timer.timer_arrival_window
        state: "active"

      # Хотя бы один из датчиков (дверь/движение) в валидном состоянии
      - condition: template
        value_template: >-
          {{
            states('binary_sensor.hallway_door_contact') not in ['unknown','unavailable','']
            or states('binary_sensor.hallway_motion_ultrasonic_occupancy') not in ['unknown','unavailable','']
          }}

    action:
      # Включаем основной свет (полная яркость)
      - service: light.turn_on
        target:
          entity_id: light.hallway_switch

      # Включаем подсветку шлюза (полная яркость)
      - service: light.turn_on
        target:
          entity_id: light.gateway_light_04cf8c977cdd
        data:
          brightness_pct: 100

      # Устанавливаем флаг "уже был первый вход"
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.hallway_first_door_open

      # Отменяем таймер "окна прибытия" (больше не нужен)
      - service: timer.cancel
        target:
          entity_id: timer.timer_arrival_window

      # Запускаем таймер автовыключения
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: первый вход/присутствие после прибытия домой (полное освещение)."
          level: info

  # --------------------------------------------------------------------------
  # Открытие "окна прибытия" при возвращении домой
  # --------------------------------------------------------------------------
  - id: "reset-first-door-flag"
    alias: "Прихожая: открытие окна прибытия при возвращении домой"
    description: >
      Сбрасывает флаг и запускает "окно прибытия" при возвращении домой.

      ТРИГГЕР:
      • person.master → home (человек пришёл домой)

      ДЕЙСТВИЯ:
      1. Сброс флага hallway_first_door_open = off
      2. Запуск таймера "окна прибытия" (10 минут)

      НАЗНАЧЕНИЕ:
      • Подготовка к умному включению света при первом входе
      • Открытие 10-минутного окна для срабатывания

      ЛОГИКА:
      • Каждый раз при возвращении домой окно открывается заново
      • Если не зашёл в дом за 10 минут — окно закрывается автоматически
      • Флаг сбрасывается для нового цикла
    mode: single
    trigger:
      - platform: state
        entity_id: person.master
        to: "home"
    action:
      # Сбрасываем флаг "первое открытие двери"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.hallway_first_door_open

      # Запускаем таймер "окна прибытия" (10 минут)
      - service: timer.start
        target:
          entity_id: timer.timer_arrival_window

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: прибытие домой — открыто окно 10 минут."
          level: info

  # ==========================================================================
  # УВЕДОМЛЕНИЯ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Звонок в дверь — голосовое уведомление + мигание света
  # --------------------------------------------------------------------------
  - id: "37a7b942-71ea-456e-8f9e-1718c8c34a8d"
    alias: "Прихожая: звонок в дверь (уведомление + мигание)"
    description: >
      Озвучивает уведомление и мигает светом при нажатии кнопки звонка.

      ТРИГГЕРЫ:
      • Уличная кнопка (device_id: d2c3001cdc59660c456de45aec09da91)
      • Событие звонка домофона (event.madv_cn_329651133_miowlv2l_doorbell_ring_e_2_1)

      УСЛОВИЯ:
      • Фаза запуска завершена
      • Режим тишины выключен
      • Кто-то дома (есть кому получить уведомление)

      ДЕЙСТВИЯ:
      1. Голосовое уведомление (script.yandex_tts_click_outdoor_button)
      2. Мигание света (N раз, настраивается через input_number.hallway_blink_count)
      3. Восстановление предыдущего состояния светодиодной ленты

      ЛОГИКА МИГАНИЯ:
      • Сохраняем состояние светодиодной ленты (была ли включена)
      • Мигаем обоими источниками света (шлюз + лента)
      • Восстанавливаем предыдущее состояние ленты

      КОЛИЧЕСТВО МИГАНИЙ:
      • По умолчанию: 3 раза
      • Настраивается через input_number.hallway_blink_count

      РЕЖИМ:
      • restart — новый звонок прерывает предыдущее мигание
    mode: restart
    trigger:
      # Уличная кнопка
      - platform: device
        domain: mqtt
        device_id: d2c3001cdc59660c456de45aec09da91
        type: action
        subtype: single

      # Звонок домофона
      - platform: state
        entity_id: event.madv_cn_329651133_miowlv2l_doorbell_ring_e_2_1
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
      - condition: state
        entity_id: binary_sensor.someone_is_home_2
        state: "on"
      - condition: state
        entity_id: input_boolean.xiaomi_home_integration_unstable
        state: "off"
    action:
      # Сохраняем состояние светодиодной ленты
      - variables:
          was_on_led: "{{ is_state('light.working_room_led', 'on') }}"

      # Голосовое уведомление
      - service: script.yandex_tts_click_outdoor_button

      # Мигание света (N раз)
      - repeat:
          count: "{{ states('input_number.hallway_blink_count') | int }}"
          sequence:
            # Включаем свет
            - service: light.turn_on
              target:
                entity_id:
                  - light.gateway_light_04cf8c977cdd
                  - light.working_room_led
            - delay: "00:00:01"

            # Выключаем свет
            - service: light.turn_off
              target:
                entity_id:
                  - light.gateway_light_04cf8c977cdd
                  - light.working_room_led
            - delay: "00:00:01"

      # Восстанавливаем предыдущее состояние светодиодной ленты
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ was_on_led }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.working_room_led
        default:
          - service: light.turn_off
            target:
              entity_id: light.working_room_led

      # Логирование
      - service: system_log.write
        data:
          message: "Прихожая: обработан звонок в дверь (мигание выполнено)."
          level: info

  # --------------------------------------------------------------------------
  # Попытка снятия уличной кнопки
  # --------------------------------------------------------------------------
  - id: "26345165-2c00-489c-af7b-c4b92110c937"
    alias: "Прихожая: попытка снятия уличной кнопки"
    description: >
      Отправляет уведомления при обнаружении попытки снять кнопку.

      ТРИГГЕР:
      • Уличная кнопка (device_id: d2c3001cdc59660c456de45aec09da91)
      • Действие: встряхивание (shake)

      УСЛОВИЯ:
      • Фаза запуска завершена
      • Режим тишины выключен

      ДЕЙСТВИЯ:
      1. Голосовое уведомление (script.yandex_tts_shaking_outdoor_button)
      2. Telegram-уведомление (notify.master)
      3. Запись в лог (уровень warning)

      НАЗНАЧЕНИЕ:
      • Безопасность — раннее обнаружение взлома/вандализма
      • Немедленное уведомление владельца
    mode: single
    trigger:
      - platform: device
        domain: mqtt
        device_id: d2c3001cdc59660c456de45aec09da91
        type: action
        subtype: shake
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
    action:
      # Голосовое уведомление
      - service: script.yandex_tts_shaking_outdoor_button

      # Telegram-уведомление
      - service: notify.master
        data:
          message: "⚠️ ВНИМАНИЕ! Кто-то пытается снять уличную кнопку! 🛑"

      # Логирование
      - service: system_log.write
        data:
          message: "Обнаружена попытка снятия уличной кнопки."
          level: warning

  # ==========================================================================
  # МОНИТОРИНГ МИКРОКЛИМАТА СЕЙФА
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Подтверждение риска плесени в сейфе
  # --------------------------------------------------------------------------
  - id: "strongbox_risk_confirm"
    alias: "Сейф: подтверждение риска плесени"
    description: >
      Поднимает флаг уведомления при устойчивом риске плесени.

      ТРИГГЕР:
      • binary_sensor.strongbox_mold_risk: off → on
      • Риск держится устойчиво N минут (по умолчанию 10)

      УСЛОВИЯ:
      • Фаза запуска завершена
      • Флаг уведомления ещё не поднят (strongbox_hum_text_notified = off)

      ДЕЙСТВИЯ:
      1. Установка флага strongbox_hum_text_notified = on
      2. Запись в лог (уровень warning)

      ВРЕМЯ ПОДТВЕРЖДЕНИЯ:
      • По умолчанию: 10 минут
      • Настраивается через input_number.strongbox_confirm_min

      НАЗНАЧЕНИЕ:
      • Защита от ложных срабатываний
      • Подтверждение устойчивого риска
      • Флаг триггерит отправку Telegram-уведомления (в другом пакете)

      ЛОГИКА:
      ┌────────────────────────────────────────┐
      │ Риск обнаружен                         │
      │ ↓                                      │
      │ Ожидание 10 минут                      │
      │ ↓                                      │
      │ Флаг = ON → Telegram-уведомление       │
      └────────────────────────────────────────┘
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.strongbox_mold_risk
        to: "on"
        for:
          minutes: 10
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.strongbox_hum_text_notified
        state: "off"
    action:
      # Поднимаем флаг уведомления
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.strongbox_hum_text_notified

      # Логирование
      - service: system_log.write
        data:
          message: >
            Сейф: подтверждён риск плесени.
            RH: {{ states('sensor.strongbox_humidity_smoothed') }}%,
            T: {{ states('sensor.strongbox_temperature_smoothed') }}°C,
            DP: {{ states('sensor.strongbox_dew_point_c') }}°C.
          level: warning

  # --------------------------------------------------------------------------
  # Подтверждение нормализации условий в сейфе
  # --------------------------------------------------------------------------
  - id: "strongbox_risk_resolved_confirm"
    alias: "Сейф: подтверждение нормализации условий"
    description: >
      Сбрасывает флаг уведомления при устойчивой нормализации условий.

      ТРИГГЕР:
      • binary_sensor.strongbox_safe_status: off → on
      • Норма держится устойчиво N минут (по умолчанию 20)

      УСЛОВИЯ:
      • Фаза запуска завершена
      • Флаг уведомления поднят (strongbox_hum_text_notified = on)

      ДЕЙСТВИЯ:
      1. Сброс флага strongbox_hum_text_notified = off
      2. Запись в лог (уровень info)

      ВРЕМЯ ПОДТВЕРЖДЕНИЯ:
      • По умолчанию: 20 минут (больше, чем для риска)
      • Настраивается через input_number.strongbox_resolve_min

      НАЗНАЧЕНИЕ:
      • Защита от преждевременного сброса
      • Подтверждение устойчивой нормализации
      • Флаг триггерит отправку Telegram-уведомления "всё в порядке"

      ЛОГИКА:
      ┌────────────────────────────────────────┐
      │ Условия нормализовались                │
      │ ↓                                      │
      │ Ожидание 20 минут                      │
      │ ↓                                      │
      │ Флаг = OFF → Telegram "всё ОК"         │
      └────────────────────────────────────────┘

      ПРИМЕЧАНИЕ:
      • Время подтверждения нормы (20 мин) > времени подтверждения риска (10 мин)
      • Это предотвращает "дрожание" уведомлений при пограничных значениях
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.strongbox_safe_status
        to: "on"
        for:
          minutes: "{{ states('input_number.strongbox_resolve_min') | int(20) }}"
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.strongbox_hum_text_notified
        state: "on"
    action:
      # Сбрасываем флаг уведомления
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.strongbox_hum_text_notified

      # Логирование
      - service: system_log.write
        data:
          message: >
            Сейф: условия нормализованы.
            RH: {{ states('sensor.strongbox_humidity_smoothed') }}%,
            T: {{ states('sensor.strongbox_temperature_smoothed') }}°C.
          level: info
