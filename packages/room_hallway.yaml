################################################################################
# /packages/room_hallway.yaml
################################################################################
#
# –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–•–û–ñ–ï–ô –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–ï–ô–§–ê
#
# –§–£–ù–ö–¶–ò–ò:
# 1. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–∂–µ–π
#    ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π (—Ä—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ)
#    ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏
#    ‚Ä¢ –î–∞—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
#    ‚Ä¢ –¢–∞–π–º–µ—Ä –∞–≤—Ç–æ–≤—ã–∫–ª—é—á–µ–Ω–∏—è (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π)
#    ‚Ä¢ "–û–∫–Ω–æ –ø—Ä–∏–±—ã—Ç–∏—è" ‚Äî —É–º–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –¥–æ–º–æ–π
#
# 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
#    ‚Ä¢ –ó–≤–æ–Ω–æ–∫ –≤ –¥–≤–µ—Ä—å ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + –º–∏–≥–∞–Ω–∏–µ —Å–≤–µ—Ç–∞
#    ‚Ä¢ –ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç–∏—è –∫–Ω–æ–ø–∫–∏ ‚Äî TTS + Telegram
#
# 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç–∞ —Å–µ–π—Ñ–∞ (strongbox)
#    ‚Ä¢ –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ (5 –º–∏–Ω)
#    ‚Ä¢ –†–∞—Å—á—ë—Ç —Ç–æ—á–∫–∏ —Ä–æ—Å—ã –∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ–π –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
#    ‚Ä¢ –î–µ—Ç–µ–∫—Ü–∏—è —Ä–∏—Å–∫–∞ –ø–ª–µ—Å–µ–Ω–∏ —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º
#    ‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∏—Å–∫–∞/–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)
#    ‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram
#
# –£–°–¢–†–û–ô–°–¢–í–ê:
# ‚Ä¢ light.hallway_switch ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–≤–µ—Ç –ø—Ä–∏—Ö–æ–∂–µ–π
# ‚Ä¢ light.gateway_light_04cf8c977cdd ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —à–ª—é–∑–∞
# ‚Ä¢ binary_sensor.hallway_door_contact ‚Äî –¥–∞—Ç—á–∏–∫ –¥–≤–µ—Ä–∏
# ‚Ä¢ binary_sensor.hallway_motion_ultrasonic_occupancy ‚Äî –¥–∞—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è
# ‚Ä¢ sensor.illumination_04cf8c977cdd ‚Äî –¥–∞—Ç—á–∏–∫ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
# ‚Ä¢ sensor.strongbox_th_temperature ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–µ–π—Ñ–∞
# ‚Ä¢ sensor.strongbox_th_humidity ‚Äî –≤–ª–∞–∂–Ω–æ—Å—Ç—å —Å–µ–π—Ñ–∞
#
# –í–´–ö–õ–Æ–ß–ê–¢–ï–õ–ò/–ö–ù–û–ü–ö–ò:
# ‚Ä¢ device_id: cfd464e1cbfa3da2ddd4f2109d74eb4e ‚Äî –∫–Ω–æ–ø–∫–∞ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π
# ‚Ä¢ device_id: d2c3001cdc59660c456de45aec09da91 ‚Äî —É–ª–∏—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–∑–≤–æ–Ω–æ–∫)
#
# –ó–ê–í–ò–°–ò–ú–û–°–¢–ò:
# ‚Ä¢ script.yandex_tts_click_outdoor_button ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ
# ‚Ä¢ script.yandex_tts_shaking_outdoor_button ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–ø—ã—Ç–∫–µ —Å–Ω—è—Ç–∏—è
# ‚Ä¢ notify.master ‚Äî Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
# ‚Ä¢ input_boolean.bathroom_cleaning_mode ‚Äî —Ä–µ–∂–∏–º —É–±–æ—Ä–∫–∏
#
################################################################################

##############################################################################
#                        –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ï –ü–ê–†–ê–ú–ï–¢–†–´
##############################################################################

input_number:
  # ==========================================================================
  # –û–°–í–ï–©–ï–ù–ò–ï –ü–†–ò–•–û–ñ–ï–ô
  # ==========================================================================

  hallway_timer_duration:
    name: "–ü—Ä–∏—Ö–æ–∂–∞—è: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–∞–π–º–µ—Ä–∞ (–º–∏–Ω)"
    min: 1
    max: 5
    step: 0.5
    initial: 1.5
    icon: mdi:timer

  hallway_blink_count:
    name: "–ü—Ä–∏—Ö–æ–∂–∞—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–≥–∞–Ω–∏–π –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ"
    min: 1
    max: 5
    step: 1
    initial: 3
    icon: mdi:lightbulb-multiple

  # ==========================================================================
  # –°–ï–ô–§: –ü–û–†–û–ì–ò –ú–ò–ö–†–û–ö–õ–ò–ú–ê–¢–ê
  # ==========================================================================

  strongbox_humidity_high:
    name: "–°–µ–π—Ñ: –ø–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –í–ö–õ (%)"
    min: 50
    max: 85
    step: 1
    initial: 65
    icon: mdi:water-percent-alert

  strongbox_humidity_low:
    name: "–°–µ–π—Ñ: –ø–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –í–´–ö–õ (%)"
    min: 40
    max: 80
    step: 1
    initial: 55
    icon: mdi:water-percent

  strongbox_temp_min:
    name: "–°–µ–π—Ñ: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)"
    min: 5
    max: 25
    step: 0.5
    initial: 15
    icon: mdi:thermometer-low

  # ==========================================================================
  # –°–ï–ô–§: –í–†–ï–ú–ï–ù–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
  # ==========================================================================

  strongbox_confirm_min:
    name: "–°–µ–π—Ñ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ (–º–∏–Ω)"
    min: 1
    max: 60
    step: 1
    initial: 10
    icon: mdi:timer-alert

  strongbox_resolve_min:
    name: "–°–µ–π—Ñ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–º–∏–Ω)"
    min: 1
    max: 120
    step: 1
    initial: 20
    icon: mdi:timer-check

##############################################################################
#                          INPUT BOOLEAN
##############################################################################

input_boolean:
  # –§–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–≤–µ—Ä–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–±—ã—Ç–∏—è –¥–æ–º–æ–π
  hallway_first_door_open:
    name: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ø–µ—Ä–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–∏"
    initial: off
    icon: mdi:door-open

  # –§–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –º–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç–µ —Å–µ–π—Ñ–∞
  strongbox_hum_text_notified:
    name: "–°–µ–π—Ñ: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
    initial: off
    icon: mdi:message-alert

##############################################################################
#                               –¢–ê–ô–ú–ï–†–´
##############################################################################

timer:
  # ==========================================================================
  # –¢–∞–π–º–µ—Ä –∞–≤—Ç–æ–≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π
  # ==========================================================================
  timer_hallway:
    name: "–ü—Ä–∏—Ö–æ–∂–∞—è: —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–≤—ã–∫–ª—é—á–µ–Ω–∏—è"
    duration: "00:01:30" # –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ; —Ä–µ–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–¥–∞—ë—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    icon: mdi:timer-off

  # ==========================================================================
  # –¢–∞–π–º–µ—Ä "–æ–∫–Ω–∞ –ø—Ä–∏–±—ã—Ç–∏—è" –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –¥–æ–º–æ–π
  # ==========================================================================
  timer_arrival_window:
    name: "–ü—Ä–∏—Ö–æ–∂–∞—è: –æ–∫–Ω–æ –ø—Ä–∏–±—ã—Ç–∏—è –¥–æ–º–æ–π"
    duration: "00:10:00"
    icon: mdi:home-import-outline

##############################################################################
#                          –°–ì–õ–ê–ñ–ï–ù–ù–´–ï –°–ï–ù–°–û–†–´
##############################################################################

sensor:
  # ==========================================================================
  # –°–≥–ª–∞–∂–µ–Ω–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å —Å–µ–π—Ñ–∞ (5 –º–∏–Ω —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ)
  # ==========================================================================
  - platform: filter
    name: "–°–µ–π—Ñ: –≤–ª–∞–∂–Ω–æ—Å—Ç—å (—Å–≥–ª–∞–∂–µ–Ω–Ω–∞—è)"
    unique_id: strongbox_humidity_smoothed
    entity_id: sensor.strongbox_th_humidity
    filters:
      - filter: time_simple_moving_average
        window_size: "00:05"
        precision: 1

  # ==========================================================================
  # –°–≥–ª–∞–∂–µ–Ω–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–µ–π—Ñ–∞ (5 –º–∏–Ω —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ)
  # ==========================================================================
  - platform: filter
    name: "–°–µ–π—Ñ: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (—Å–≥–ª–∞–∂–µ–Ω–Ω–∞—è)"
    unique_id: strongbox_temperature_smoothed
    entity_id: sensor.strongbox_th_temperature
    filters:
      - filter: time_simple_moving_average
        window_size: "00:05"
        precision: 2

##############################################################################
#                          –í–´–ß–ò–°–õ–Ø–ï–ú–´–ï –°–ï–ù–°–û–†–´
##############################################################################

template:
  - sensor:
      # ======================================================================
      # –¢–æ—á–∫–∞ —Ä–æ—Å—ã –≤ —Å–µ–π—Ñ–µ (Dew Point)
      # ======================================================================
      - name: "–°–µ–π—Ñ: —Ç–æ—á–∫–∞ —Ä–æ—Å—ã"
        unique_id: strongbox_dew_point_c
        state_class: measurement
        unit_of_measurement: "¬∞C"
        icon: mdi:water-thermometer
        availability: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable',''] }}
        state: >-
          {% set T  = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% if RH <= 0 %}
            unknown
          {% else %}
            {% set a, b = 17.62, 243.12 %}
            {% set gamma = ((a * T) / (b + T)) + (RH / 100) | log %}
            {{ ((b * gamma) / (a - gamma)) | round(2) }}
          {% endif %}

      # ======================================================================
      # –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –≤ —Å–µ–π—Ñ–µ (–≥/–º¬≥)
      # ======================================================================
      - name: "–°–µ–π—Ñ: –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å"
        unique_id: strongbox_absolute_humidity_gm3
        unit_of_measurement: "–≥/–º¬≥"
        icon: mdi:water-opacity
        availability: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable',''] }}
        state: >-
          {% set T  = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% if RH <= 0 %}
            unknown
          {% else %}
            {% set e = 2.718281828459045 %}
            {% set x = (17.67 * T) / (T + 243.5) %}
            {{ (1324.95 * (RH / 100.0) * (e ** x) / (T + 273.15)) | round(2) }}
          {% endif %}

##############################################################################
#                          –ë–ò–ù–ê–†–ù–´–ï –°–ï–ù–°–û–†–´
##############################################################################

binary_sensor:
  - platform: template
    sensors:
      # ======================================================================
      # –†–∏—Å–∫ –ø–ª–µ—Å–µ–Ω–∏ –≤ —Å–µ–π—Ñ–µ (—Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º)
      # ======================================================================
      strongbox_mold_risk:
        unique_id: strongbox_mold_risk
        friendly_name: "–°–µ–π—Ñ: —Ä–∏—Å–∫ –ø–ª–µ—Å–µ–Ω–∏"
        device_class: problem
        availability_template: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_dew_point_c') not in ['unknown','unavailable',''] }}
        value_template: >-
          {% set T   = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH  = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% set dp  = states('sensor.strongbox_dew_point_c')         | float(-100) %}
          {% set hi  = states('input_number.strongbox_humidity_high') | float(65) %}
          {% set lo  = states('input_number.strongbox_humidity_low')  | float(55) %}
          {% set was = is_state('binary_sensor.strongbox_mold_risk','on') %}

          {% set close_to_dp = (T - dp) <= 1.0 %}

          {% if was %}
            {{ (RH >= lo and close_to_dp) }}
          {% else %}
            {{ (RH >= hi or (RH >= lo and close_to_dp)) }}
          {% endif %}
        icon_template: >-
          {% if is_state('binary_sensor.strongbox_mold_risk', 'on') %}
            mdi:biohazard
          {% else %}
            mdi:shield-check
          {% endif %}

      # ======================================================================
      # –£—Å–ª–æ–≤–∏—è –≤ —Å–µ–π—Ñ–µ –≤ –Ω–æ—Ä–º–µ
      # ======================================================================
      strongbox_safe_status:
        unique_id: strongbox_safe_status
        friendly_name: "–°–µ–π—Ñ: —É—Å–ª–æ–≤–∏—è –≤ –Ω–æ—Ä–º–µ"
        device_class: safety
        availability_template: >-
          {{ states('sensor.strongbox_temperature_smoothed') not in ['unknown','unavailable','']
             and states('sensor.strongbox_humidity_smoothed') not in ['unknown','unavailable',''] }}
        value_template: >-
          {% set T    = states('sensor.strongbox_temperature_smoothed') | float(0) %}
          {% set RH   = states('sensor.strongbox_humidity_smoothed')    | float(0) %}
          {% set lo   = states('input_number.strongbox_humidity_low')   | float(55) %}
          {% set tmin = states('input_number.strongbox_temp_min')       | float(15) %}
          {{ RH <= lo and T >= tmin }}
        icon_template: >-
          {% if is_state('binary_sensor.strongbox_safe_status', 'on') %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}

##############################################################################
#                             –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò
##############################################################################

automation:
  # ==========================================================================
  # –û–°–í–ï–©–ï–ù–ò–ï –ü–†–ò–•–û–ñ–ï–ô
  # ==========================================================================

  # --------------------------------------------------------------------------
  # –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–æ–º –∫–Ω–æ–ø–∫–æ–π
  # --------------------------------------------------------------------------
  - id: "fc57ec27-9c9d-489a-8f5f-050b489466f7"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –∫–Ω–æ–ø–∫–æ–π"
    description: >
      –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏.
    mode: restart
    trigger:
      - platform: device
        domain: mqtt
        device_id: cfd464e1cbfa3da2ddd4f2109d74eb4e
        type: action
        subtype: single
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    action:
      # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç
      - type: toggle
        device_id: 61c0ac07893316543e261176eb0cb5f9
        entity_id: 89add52cab26b9b6bcad7e86fd6387ec
        domain: light

      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–≤–µ—Ç–∞
      - choose:
          # –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞ –≤–∫–ª—é—á—ë–Ω ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: light.hallway_switch
                    state: "on"
                  - condition: state
                    entity_id: light.gateway_light_04cf8c977cdd
                    state: "on"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.timer_hallway
                data:
                  duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"
        default:
          # –í–µ—Å—å —Å–≤–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω ‚Üí –æ—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä
          - service: timer.cancel
            target:
              entity_id: timer.timer_hallway

  # --------------------------------------------------------------------------
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏
  # --------------------------------------------------------------------------
  - id: "3c9a07a9-58ee-4287-87ee-734687c93bba"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏"
    description: >
      –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏.
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_door_contact
        to: "on"
        for:
          seconds: 5
    condition:
      - condition: state
        entity_id: light.hallway_switch
        state: "off"
      - condition: time
        after: "08:30:00"
        before: "23:00:00"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: template
        value_template: "{{ states('binary_sensor.hallway_door_contact') not in ['unknown','unavailable',''] }}"
    action:
      - service: light.turn_on
        target:
          entity_id: light.hallway_switch

      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

  # --------------------------------------------------------------------------
  # –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∏ –Ω–∏–∑–∫–æ–π –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
  # --------------------------------------------------------------------------
  - id: "7f815fb8-98f4-437a-96fc-06984d9a4a25"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∏ –Ω–∏–∑–∫–æ–π –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏"
    description: >
      –í–∫–ª—é—á–∞–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É —à–ª—é–∑–∞ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –≤ —Ç—ë–º–Ω–æ–µ –≤—Ä–µ–º—è.
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "on"
    condition:
      - condition: numeric_state
        entity_id: sensor.illumination_04cf8c977cdd
        below: 250
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: template
        value_template: "{{ states('binary_sensor.hallway_motion_ultrasonic_occupancy') not in ['unknown','unavailable',''] }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.someone_is_home_2
            state: "on"
          - condition: state
            entity_id: input_boolean.bathroom_cleaning_mode
            state: "on"
    action:
      - service: light.turn_on
        target:
          entity_id: light.gateway_light_04cf8c977cdd
        data:
          brightness_pct: 7

      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

  # --------------------------------------------------------------------------
  # –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
  # --------------------------------------------------------------------------
  - id: "3b6e37de-3b10-4201-afad-221dbe4cd4a0"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è"
    description: >
      –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–≤—ã–∫–ª—é—á–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª–æ—Å—å.
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "off"
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: light.hallway_switch
            state: "on"
          - condition: state
            entity_id: light.gateway_light_04cf8c977cdd
            state: "on"
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
    action:
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

  # --------------------------------------------------------------------------
  # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
  # --------------------------------------------------------------------------
  - id: "479b917d-e4c2-4149-97e7-d12779b9f3ce"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏"
    description: >
      –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –æ—Å–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ –Ω–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏.
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "on"
        for:
          seconds: 2
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: light.hallway_switch
            state: "on"
          - condition: state
            entity_id: light.gateway_light_04cf8c977cdd
            state: "on"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.someone_is_home_2
            state: "on"
          - condition: state
            entity_id: input_boolean.bathroom_cleaning_mode
            state: "on"
    action:
      - service: timer.cancel
        target:
          entity_id: timer.timer_hallway

      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

  # --------------------------------------------------------------------------
  # –í—ã–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É
  # --------------------------------------------------------------------------
  - id: "7f6bdbae-a73b-4509-8db8-43f71a3525ca"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É"
    description: >
      –í—ã–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞.
    mode: single
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.timer_hallway
    condition:
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
    action:
      - service: light.turn_off
        target:
          entity_id:
            - light.hallway_switch
            - light.gateway_light_04cf8c977cdd

  # ==========================================================================
  # "–û–ö–ù–û –ü–†–ò–ë–´–¢–ò–Ø"
  # ==========================================================================

  - id: "first-door-home-automation"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ø–µ—Ä–≤–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –ø—Ä–∏—Ö–æ–∂—É—é –ø–æ—Å–ª–µ –ø—Ä–∏—Ö–æ–¥–∞ –¥–æ–º–æ–π"
    description: >
      –í–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—è–≤–ª–µ–Ω–∏–∏ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π
      –ø–æ—Å–ª–µ –ø—Ä–∏–±—ã—Ç–∏—è –¥–æ–º–æ–π.
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_door_contact
        to: "on"
        for:
          seconds: 2
      - platform: state
        entity_id: binary_sensor.hallway_motion_ultrasonic_occupancy
        to: "on"
        for:
          seconds: 2
    condition:
      - condition: state
        entity_id: input_boolean.hallway_first_door_open
        state: "off"
      - condition: state
        entity_id: person.master
        state: "home"
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: timer.timer_arrival_window
        state: "active"
      - condition: template
        value_template: >-
          {{
            states('binary_sensor.hallway_door_contact') not in ['unknown','unavailable','']
            or states('binary_sensor.hallway_motion_ultrasonic_occupancy') not in ['unknown','unavailable','']
          }}
    action:
      - service: light.turn_on
        target:
          entity_id: light.hallway_switch

      - service: light.turn_on
        target:
          entity_id: light.gateway_light_04cf8c977cdd
        data:
          brightness_pct: 100

      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.hallway_first_door_open

      - service: timer.cancel
        target:
          entity_id: timer.timer_arrival_window

      - service: timer.start
        target:
          entity_id: timer.timer_hallway
        data:
          duration: "{{ (states('input_number.hallway_timer_duration') | float(1.5) * 60) | int }}"

  - id: "reset-first-door-flag"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –æ—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø—Ä–∏–±—ã—Ç–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –¥–æ–º–æ–π"
    description: >
      –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç "–æ–∫–Ω–æ –ø—Ä–∏–±—ã—Ç–∏—è" –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –¥–æ–º–æ–π.
    mode: single
    trigger:
      - platform: state
        entity_id: person.master
        to: "home"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.hallway_first_door_open

      - service: timer.start
        target:
          entity_id: timer.timer_arrival_window

  # ==========================================================================
  # –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
  # ==========================================================================

  - id: "37a7b942-71ea-456e-8f9e-1718c8c34a8d"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –∑–≤–æ–Ω–æ–∫ –≤ –¥–≤–µ—Ä—å (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + –º–∏–≥–∞–Ω–∏–µ)"
    description: >
      –û–∑–≤—É—á–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –º–∏–≥–∞–µ—Ç —Å–≤–µ—Ç–æ–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –∑–≤–æ–Ω–∫–∞.
    mode: restart
    trigger:
      - platform: device
        domain: mqtt
        device_id: d2c3001cdc59660c456de45aec09da91
        type: action
        subtype: single
      - platform: state
        entity_id: event.madv_cn_329651133_miowlv2l_doorbell_ring_e_2_1
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
      - condition: state
        entity_id: binary_sensor.someone_is_home_2
        state: "on"
      - condition: state
        entity_id: input_boolean.xiaomi_home_integration_unstable
        state: "off"
    action:
      - variables:
          was_on_led: "{{ is_state('light.working_room_led', 'on') }}"

      - service: script.yandex_tts_click_outdoor_button

      - repeat:
          count: "{{ states('input_number.hallway_blink_count') | int }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id:
                  - light.gateway_light_04cf8c977cdd
                  - light.working_room_led
            - delay: "00:00:01"
            - service: light.turn_off
              target:
                entity_id:
                  - light.gateway_light_04cf8c977cdd
                  - light.working_room_led
            - delay: "00:00:01"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ was_on_led }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.working_room_led
        default:
          - service: light.turn_off
            target:
              entity_id: light.working_room_led

  - id: "26345165-2c00-489c-af7b-c4b92110c937"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ø–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç–∏—è –Ω–∞—Ä—É–∂–Ω–æ–π –∫–Ω–æ–ø–∫–∏"
    description: >
      –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–æ–ø—ã—Ç–∫–∏ —Å–Ω—è—Ç—å –∫–Ω–æ–ø–∫—É.
    mode: single
    trigger:
      - platform: device
        domain: mqtt
        device_id: d2c3001cdc59660c456de45aec09da91
        type: action
        subtype: shake
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
    action:
      - service: script.yandex_tts_shaking_outdoor_button

      - service: notify.send_message
        target:
          entity_id: notify.telegram_master
        data:
          message: "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –ö—Ç–æ-—Ç–æ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–Ω—è—Ç—å –Ω–∞—Ä—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É! üõë"

  # ==========================================================================
  # –ú–û–ù–ò–¢–û–†–ò–ù–ì –ú–ò–ö–†–û–ö–õ–ò–ú–ê–¢–ê –°–ï–ô–§–ê
  # ==========================================================================

  - id: "strongbox_risk_confirm"
    alias: "–°–µ–π—Ñ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ –ø–ª–µ—Å–µ–Ω–∏"
    description: >
      –ü–æ–¥–Ω–∏–º–∞–µ—Ç —Ñ–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —É—Å—Ç–æ–π—á–∏–≤–æ–º —Ä–∏—Å–∫–µ –ø–ª–µ—Å–µ–Ω–∏.
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.strongbox_mold_risk
        to: "on"
        for:
          minutes: 10
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.strongbox_hum_text_notified
        state: "off"
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.strongbox_hum_text_notified

  - id: "strongbox_risk_resolved_confirm"
    alias: "–°–µ–π—Ñ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å–ª–æ–≤–∏–π"
    description: >
      –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —É—Å—Ç–æ–π—á–∏–≤–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å–ª–æ–≤–∏–π.
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.strongbox_safe_status
        to: "on"
        for:
          minutes: "{{ states('input_number.strongbox_resolve_min') | int(20) }}"
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.strongbox_hum_text_notified
        state: "on"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.strongbox_hum_text_notified
