################################################################################
# /packages/room_hallway.yaml
################################################################################
#
# –≠—Ç–æ—Ç –ø–∞–∫–µ—Ç Home Assistant –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ—Å–≤–µ—â–µ–Ω–∏—è –≤ –ø—Ä–∏—Ö–æ–∂–µ–π,
# –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —É–¥–æ–±—Å—Ç–≤–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—Ç–æ–º. –í–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è
# –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤
# –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥–µ, –∞ —Ç–∞–∫–∂–µ —Ç–∞–π–º–µ—Ä –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∫–ª—é—á–µ–Ω–∏—è
# —Å–≤–µ—Ç–∞.
#
################################################################################

##############################################################################
#                             –í–•–û–î–ù–´–ï –ë–£–õ–ï–í–´ –ü–ï–†–ï–ú–ï–ù–ù–´–ï
##############################################################################
input_boolean:
  hallway_first_door_open:
    name: "–ü–µ—Ä–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–∏ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π"
    initial: off
    icon: mdi:door-open

##############################################################################
#                                –¢–ê–ô–ú–ï–†–´
##############################################################################
timer:
  timer_hallway:
    name: "–î–≤–∏–∂–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
    duration: "00:01:30"

##############################################################################
#                             –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò
##############################################################################
automation:
  # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π –ø–æ –∫–Ω–æ–ø–∫–µ
  - id: "fc57ec27-9c9d-489a-8f5f-050b489466f7"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –í–∫–ª/–≤—ã–∫–ª —Å–≤–µ—Ç–∞ –∫–Ω–æ–ø–∫–æ–π"
    description: >
      –†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏, –≤–∫–ª—é—á–∞—è –∏–ª–∏ –≤—ã–∫–ª—é—á–∞—è –æ—Å–≤–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π.
      –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ
      –≤—ã–∫–ª—é—á–µ–Ω–∏—è –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏.
    triggers:
      - platform: device
        domain: mqtt
        device_id: cfd464e1cbfa3da2ddd4f2109d74eb4e
        type: action
        subtype: single
    actions:
      - type: toggle
        device_id: 61c0ac07893316543e261176eb0cb5f9
        entity_id: 89add52cab26b9b6bcad7e86fd6387ec
        domain: light
      - choose:
          - conditions:
              - condition: state
                entity_id: light.hallway_switch
                state: "on"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.timer_hallway
    mode: single

  # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏
  - id: "3c9a07a9-58ee-4287-87ee-734687c93bba"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏"
    description: >
      –†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–∏, –≤–∫–ª—é—á–∞—è —Å–≤–µ—Ç –≤ –ø—Ä–∏—Ö–æ–∂–µ–π. –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞
      –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è.
    triggers:
      - platform: state
        entity_id: binary_sensor.hallway_door_contact
        to: "on"
    conditions:
      - condition: state
        entity_id: light.hallway_switch
        state: "off"
      - condition: time
        after: "08:30:00"
        before: "23:00:00"
    actions:
      - service: light.turn_on
        target:
          entity_id: light.hallway_switch
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
    mode: single

  # –í–∫–ª —Å–≤–µ—Ç–∞ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∏ –Ω–∏–∑–∫–æ–π –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏
  - id: "7f815fb8-98f4-437a-96fc-06984d9a4a25"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –í–∫–ª —Å–≤–µ—Ç–∞ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∏ –Ω–∏–∑–∫–æ–π –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏"
    description: >
      –í–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∏ –Ω–∏–∑–∫–æ–π –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π.
      –°–≤–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏—è
      –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.
    triggers:
      - platform: state
        entity_id: binary_sensor.hallway_motion_occupancy
        to: "on"
    conditions:
      - condition: numeric_state
        entity_id: sensor.illumination_04cf8c977cdd
        below: 250
    actions:
      - service: light.turn_on
        target:
          entity_id: light.gateway_light_04cf8c977cdd
        data:
          brightness_pct: 7
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
    mode: single

  # –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
  - id: "3b6e37de-3b10-4201-afad-221dbe4cd4a0"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è"
    description: >
      –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä, –∫–æ–≥–¥–∞ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ.
    triggers:
      - platform: state
        entity_id: binary_sensor.hallway_motion_occupancy
        to: "off"
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: light.hallway_switch
            state: "on"
          - condition: state
            entity_id: light.gateway_light_04cf8c977cdd
            state: "on"
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
    actions:
      - service: timer.start
        target:
          entity_id: timer.timer_hallway

  # –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
  - id: "479b917d-e4c2-4149-97e7-d12779b9f3ce"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è"
    description: >
      –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ø—Ä–∏—Ö–æ–∂–µ–π.
    triggers:
      - platform: state
        entity_id: binary_sensor.hallway_motion_occupancy
        to: "on"
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: light.hallway_switch
            state: "on"
          - condition: state
            entity_id: light.gateway_light_04cf8c977cdd
            state: "on"
    actions:
      - service: timer.cancel
        target:
          entity_id: timer.timer_hallway
      - service: timer.start
        target:
          entity_id: timer.timer_hallway

  # –í—ã–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É
  - id: "7f6bdbae-a73b-4509-8db8-43f71a3525ca"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –í—ã–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É"
    description: >
      –í—ã–∫–ª—é—á–∞–µ—Ç –æ—Å–≤–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ç–∞–π–º–µ—Ä–∞, —ç–∫–æ–Ω–æ–º—è —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—é.
      –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ —É–±–æ—Ä–∫–∏.
    triggers:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.timer_hallway
    conditions:
      - condition: state
        entity_id: input_boolean.bathroom_cleaning_mode
        state: "off"
    actions:
      - service: light.turn_off
        target:
          entity_id:
            - light.hallway_switch
            - light.gateway_light_04cf8c977cdd
    mode: single

  # –ù–æ–≤–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏ –ø–æ—Å–ª–µ –ø—Ä–∏—Ö–æ–¥–∞
  - id: "first-door-home-automation"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –í–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏ –ø–æ—Å–ª–µ –ø—Ä–∏—Ö–æ–¥–∞ –¥–æ–º–æ–π"
    description: >
      –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (person.master) —Å—Ç–∞–ª –¥–æ–º–∞, —Ç–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏,
      –µ—Å–ª–∏ —Å –º–æ–º–µ–Ω—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ –¥–≤–µ—Ä—å –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å (—Ñ–ª–∞–≥ hallway_first_door_open = off)
      –∏ –≤—Ä–µ–º—è —Å –ø—Ä–∏—Ö–æ–¥–∞ –º–µ–Ω–µ–µ 10 –º–∏–Ω—É—Ç, –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Å–≤–µ—Ç –≤ –ø—Ä–∏—Ö–æ–∂–µ–π.
    triggers:
      - platform: state
        entity_id: binary_sensor.hallway_door_contact
        to: "on"
    conditions:
      - condition: state
        entity_id: input_boolean.hallway_first_door_open
        state: "off"
      - condition: state
        entity_id: person.master
        state: "home"
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states.person.master.last_changed)) < 600 }}
    actions:
      - service: light.turn_on
        target:
          entity_id: light.hallway_switch
      - service: light.turn_on
        target:
          entity_id: light.gateway_light_04cf8c977cdd
        data:
          brightness_pct: 100
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.hallway_first_door_open
      - service: timer.start
        target:
          entity_id: timer.timer_hallway
    mode: single

  # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–ª–∞–≥–∞ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–≤–µ—Ä–∏ –ø—Ä–∏ —É—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - id: "reset-first-door-flag"
    alias: "–ü—Ä–∏—Ö–æ–∂–∞—è: –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–≤–µ—Ä–∏"
    description: >
      –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (person.master)
      –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ not_home.
    triggers:
      - platform: state
        entity_id: person.master
        to: "not_home"
    actions:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.hallway_first_door_open
    mode: single

  # –û–ø–æ–≤–µ—â–µ–Ω–∏—è –æ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –∑–≤–æ–Ω–∫–∞ –Ω–∞ –≤—Ö–æ–¥–Ω–æ–π –¥–≤–µ—Ä–∏
  - id: "37a7b942-71ea-456e-8f9e-1718c8c34a8d"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –Ø–Ω–¥–µ–∫—Å: –ó–≤–æ–Ω–æ–∫ –≤ –¥–≤–µ—Ä—å"
    description: >
      –ê–ª–∏—Å–∞ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –∏ –º–∏–≥–∞–µ—Ç —Å–≤–µ—Ç–æ–º —á–µ—Ä–µ–∑ Xiaomi Gateway –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏.
    triggers:
      - platform: device
        domain: mqtt
        device_id: d2c3001cdc59660c456de45aec09da91
        type: action
        subtype: single
    actions:
      - service: script.yandex_tts_click_outdoor_button # –í—ã–∑–æ–≤ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞
      - repeat:
          count: 3
          sequence:
            - service: light.turn_on
              target:
                entity_id:
                  - light.gateway_light_04cf8c977cdd
                  - light.working_room_led
            - delay: "00:00:01"
            - service: light.turn_off
              target:
                entity_id:
                  - light.gateway_light_04cf8c977cdd
                  - light.working_room_led
            - delay: "00:00:01"
      - choose:
          - conditions:
              - condition: state
                entity_id: light.working_room_led
                state: "off"
            sequence:
              - service: light.turn_off
                target:
                  entity_id: light.working_room_led
    mode: single

  # –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ —Å–Ω—è—Ç–∏—è –≤—Ö–æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
  - id: "26345165-2c00-489c-af7b-c4b92110c937"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –í—Ö–æ–¥–Ω—É—é –∫–Ω–æ–ø–∫—É –ø—ã—Ç–∞—é—Ç—Å—è —Å–Ω—è—Ç—å"
    description: >
      –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ —Å–Ω—è—Ç–∏—è –≤—Ö–æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.
    triggers:
      - platform: device
        domain: mqtt
        device_id: d2c3001cdc59660c456de45aec09da91
        type: action
        subtype: shake
    actions:
      - service: script.yandex_tts_shaking_outdoor_button
      - service: notify.master
        data:
          message: "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –í—Ö–æ–¥–Ω—É—é –∫–Ω–æ–ø–∫—É –ø—ã—Ç–∞—é—Ç—Å—è —Å–Ω—è—Ç—å üõë"
    mode: single
