################################################################################
# /packages/washing_machine.yaml
################################################################################
#
# –ü–∞–∫–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π Home Assistant –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–±–æ—Ç—ã —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
# –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
#
# –ò–∑–º–µ–Ω–µ–Ω–∏—è/—É—Ç–æ—á–Ω–µ–Ω–∏—è:
#  - –£–±—Ä–∞–Ω—ã —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–æ input_boolean.washing_machine_finished (–æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ
#    binary_sensor.washing_machine_finished).
#  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Telegram + TTS –Ω–∞ –Ø–Ω–¥–µ–∫—Å-–∫–æ–ª–æ–Ω–∫—É.
#  - –°–±—Ä–æ—à–µ–Ω —Å–µ—Ä–≤–∏—Å notify.notify.
#
# –î–æ—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–∑—ã–≤–∞:
#  - –î–æ–±–∞–≤–ª–µ–Ω –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –≤ binary_sensor (delay_off –¥–ª—è active, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è delay_on).
#  - –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ —Å–±—Ä–æ—Å–æ–≤ –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ.
#  - –£–ø—Ä–æ—â–µ–Ω—ã —É—Å–ª–æ–≤–∏—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö (–¥–æ–±–∞–≤–ª–µ–Ω silent_mode –≤ Telegram, –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ someone_is_home).
#  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π.
#  - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ç–∏—Ä–∫–∏ —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ 10 –º–∏–Ω –≤ —à–∞–±–ª–æ–Ω–µ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ).
#
################################################################################

input_number:
  wm_min_cycle_min:
    name: "–°—Ç–∏—Ä–∞–ª–∫–∞: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏–∫–ª–∞ (–º–∏–Ω)"
    min: 5
    max: 180
    step: 5
    initial: 10

input_datetime:
  washing_machine_started_at:
    name: "–°—Ç–∏—Ä–∞–ª–∫–∞: –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ —Ü–∏–∫–ª–∞"
    has_date: true
    has_time: true

input_boolean:
  washing_machine_running:
    name: "–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    initial: off
    icon: mdi:washing-machine

  washing_machine_pre_restart_state:
    name: "Washing Machine Pre-Restart State"
    initial: off
    icon: mdi:washing-machine

binary_sensor:
  - platform: template
    sensors:
      washing_machine_active:
        friendly_name: "–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞"
        availability_template: >
          {{ states('sensor.bathroom_washing_machine_power') not in ['unknown', 'unavailable', ''] }}
        value_template: >
          {{ (states('sensor.bathroom_washing_machine_power') | float(0)) > 5 }}
        delay_off:
          minutes: 1  # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ø–∞–¥—ã –º–æ—â–Ω–æ—Å—Ç–∏

      washing_machine_finished:
        friendly_name: "–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ —Å—Ç–∏—Ä–∫—É"
        availability_template: >
          {{ states('sensor.bathroom_washing_machine_power') not in ['unknown', 'unavailable', ''] }}
        value_template: >
          {{ (states('sensor.bathroom_washing_machine_power') | float(0)) < 5 }}
        delay_on:
          minutes: 2  # —É—Å—Ç–æ–π—á–∏–≤–æ <5 –í—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 2 –º–∏–Ω—É—Ç

automation:
  ##############################################################################
  # –°–û–•–†–ê–ù–ï–ù–ò–ï/–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –ü–†–ò SHUTDOWN/START HA
  ##############################################################################
  - id: "064cbd85-8d52-40ac-98bd-98164ad1434c"
    alias: "HELPER: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ HA"
    mode: single
    trigger:
      - platform: homeassistant
        event: shutdown
        id: shutdown
      - platform: homeassistant
        event: start
        id: start
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: shutdown
            sequence:
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.washing_machine_active
                        state: "on"
                    sequence:
                      - service: input_boolean.turn_on
                        target:
                          entity_id: input_boolean.washing_machine_pre_restart_state
                default:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.washing_machine_pre_restart_state
          - conditions:
              - condition: trigger
                id: start
            sequence:
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: input_boolean.washing_machine_pre_restart_state
                        state: "on"
                    sequence:
                      - service: system_log.write
                        data:
                          message: "System start: —Å—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏."
                          level: warning
              - service: input_boolean.turn_off
                target:
                  entity_id:
                    - input_boolean.washing_machine_running
                    - input_boolean.washing_machine_pre_restart_state

  ##############################################################################
  # –°–¢–ê–¢–£–° –°–¢–ò–†–ö–ò: –°–¢–ê–†–¢/–û–ö–û–ù–ß–ê–ù–ò–ï
  ##############################################################################
  - id: "04a14878-99d3-4030-a17d-bfa3c75b1f9b"
    alias: "HELPER: –°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º (—Å—Ç–∞—Ä—Ç/–æ–∫–æ–Ω—á–∞–Ω–∏–µ)"
    description: "–í–∫–ª—é—á–∞–µ—Ç running –ø—Ä–∏ >5 –í—Ç; –≤—ã–∫–ª—é—á–∞–µ—Ç –ø—Ä–∏ <5 –í—Ç (2 –º–∏–Ω), –µ—Å–ª–∏ —Ü–∏–∫–ª –¥–ª–∏–ª—Å—è –Ω–µ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º—É–º–∞."
    mode: restart
    trigger:
      - platform: numeric_state
        entity_id: sensor.bathroom_washing_machine_power
        above: 5
        id: start
      - platform: numeric_state
        entity_id: sensor.bathroom_washing_machine_power
        below: 5
        for:
          minutes: 2  # —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å delay_on finished-—Å–µ–Ω—Å–æ—Ä–∞
        id: finish
    condition:
      - condition: template
        value_template: >
          {{ states('sensor.bathroom_washing_machine_power') not in ['unknown', 'unavailable'] }}
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: start
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.washing_machine_running
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.washing_machine_started_at
                data:
                  datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
              - service: system_log.write
                data:
                  message: "–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞."
                  level: info

          - conditions:
              - condition: trigger
                id: finish
              - condition: state
                entity_id: input_boolean.washing_machine_running
                state: "on"
              - condition: template
                value_template: >
                  {% set started = as_timestamp(states('input_datetime.washing_machine_started_at')) %}
                  {% set min_sec = (states('input_number.wm_min_cycle_min') | float(10) * 60) | int %}
                  {{ started is number and (now().timestamp() - started) >= min_sec }}
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.washing_machine_running
              - service: system_log.write
                data:
                  message: "–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
                  level: info
        default:
          # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ä–∞–Ω–Ω–∏–π –ø—Ä–æ–≤–∞–ª –º–æ—â–Ω–æ—Å—Ç–∏ (< –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
          - choose:
              - conditions:
                  - condition: trigger
                    id: finish
                  - condition: state
                    entity_id: input_boolean.washing_machine_running
                    state: "on"
                sequence:
                  - service: system_log.write
                    data:
                      message: "–ù–∏–∑–∫–∞—è –º–æ—â–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –Ω–æ —Ü–∏–∫–ª < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ."
                      level: info

  ##############################################################################
  # –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ó–ê–í–ï–†–®–ï–ù–ò–ò –°–¢–ò–†–ö–ò (TTS + TELEGRAM)
  ##############################################################################
  - id: "d1e78a7d-56c3-4d4e-b2a4-8a23f1a62a45"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –°—Ç–∏—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (TTS + Telegram)"
    description: "–ü—Ä–∏ finished=on –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç TTS –∏ Telegram, –µ—Å–ª–∏ –Ω–µ startup/silent –∏ —Ü–∏–∫–ª –¥–ª–∏–ª—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ."
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.washing_machine_finished
        to: "on"
        for:
          minutes: 2  # –¥–æ–ø. –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
      - condition: state
        entity_id: binary_sensor.someone_is_home
        state: "on"
      - condition: state
        entity_id: input_boolean.washing_machine_running
        state: "off"
      - condition: template
        value_template: >
          {% set started = as_timestamp(states('input_datetime.washing_machine_started_at')) %}
          {% set min_sec = (states('input_number.wm_min_cycle_min') | float(10) * 60) | int %}
          {{ started is number and (now().timestamp() - started) >= min_sec }}
    action:
      - service: script.yandex_tts_washing_machine_finished
      - service: notify.master
        data:
          message: "üè† –°—Ç–∏—Ä–∫–∞ –∑–∞–∫–æ–Ω—á–µ–Ω–∞! üßº"
      - service: system_log.write
        data:
          message: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ç–∏—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
          level: info

  ##############################################################################
  # –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –û –ó–ê–í–ï–†–®–ï–ù–ò–ò (–ï–°–õ–ò –ù–ï–¢ –î–í–ò–ñ–ï–ù–ò–Ø)
  ##############################################################################
  - id: "washing_machine_reminder_no_motion"
    alias: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Å—Ç–∏—Ä–∫–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è"
    description: "–ß–µ—Ä–µ–∑ 15 –º–∏–Ω –ø–æ—Å–ª–µ finished=on, –µ—Å–ª–∏ –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –∏ –¥–≤–µ—Ä—å –∑–∞–∫—Ä—ã—Ç–∞ ‚Äî –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ TTS."
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.washing_machine_finished
        to: "on"
        for:
          minutes: 15
    condition:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
      - condition: state
        entity_id: binary_sensor.someone_is_home
        state: "on"
      - condition: state
        entity_id: binary_sensor.bathroom_motions
        state: "off"
      - condition: state
        entity_id: binary_sensor.bathroom_open_door
        state: "off"
    action:
      - service: script.yandex_tts_washing_machine_reminder
      - service: system_log.write
        data:
          message: "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Å—Ç–∏—Ä–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
          level: info