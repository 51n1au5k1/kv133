################################################################################
# /packages/room_server.yaml
################################################################################
#
# МОНИТОРИНГ И УПРАВЛЕНИЕ СЕРВЕРНОЙ КОМНАТОЙ
#
# ФУНКЦИИ:
# 1. Мониторинг ИБП (источник бесперебойного питания)
#    • Контроль розеток роутера и Mini-PC
#    • Уведомления при недоступности (отключение электричества)
#
# 2. Контроль температуры
#    • Автоматическое управление вентилятором
#    • Гистерезис для предотвращения частых переключений
#    • Двухэтапная задержка выключения
#
# УСТРОЙСТВА:
# • switch.my_multi_outlet_left — розетка роутера (через ИБП)
# • switch.my_multi_outlet_right — розетка Mini-PC (через ИБП)
# • sensor.0xa4c13861a18df7c8_temperature — датчик температуры серверной
# • fan.server_fan — вентилятор охлаждения
#
# ЗАВИСИМОСТИ:
# • input_boolean.system_startup_phase — флаг фазы запуска системы
# • input_boolean.silent_mode — режим тишины (без уведомлений)
# • binary_sensor.someone_is_home_2 — наличие людей дома
#
# ЛОГИКА УПРАВЛЕНИЯ ВЕНТИЛЯТОРОМ:
# ┌─────────────────────────────────────────────────────────────────┐
# │ Температура > 30°C (2 мин)                                      │
# │ ↓                                                               │
# │ Вентилятор ВКЛ                                                  │
# │ ↓                                                               │
# │ Температура < 28°C                                              │
# │ ↓                                                               │
# │ Таймер подтверждения (30 мин) — проверка стабильности          │
# │ ↓                                                               │
# │ Таймер задержки (5 мин) — grace period перед выключением       │
# │ ↓                                                               │
# │ Вентилятор ВЫКЛ (если температура всё ещё < 28°C)              │
# └─────────────────────────────────────────────────────────────────┘
#
################################################################################

##############################################################################
#                        НАСТРАИВАЕМЫЕ ПАРАМЕТРЫ
##############################################################################

input_number:
  # ==========================================================================
  # ТЕМПЕРАТУРНЫЕ ПОРОГИ (ГИСТЕРЕЗИС)
  # ==========================================================================
  
  server_temp_high_threshold:
    name: "Порог высокой температуры сервера (°C)"
    min: 25
    max: 40
    step: 1
    initial: 30
    icon: mdi:thermometer-chevron-up

  server_temp_low_threshold:
    name: "Порог низкой температуры сервера (°C)"
    min: 20
    max: 35
    step: 1
    initial: 28
    icon: mdi:thermometer-chevron-down

  # ==========================================================================
  # ТАЙМЕРЫ УПРАВЛЕНИЯ ВЕНТИЛЯТОРОМ
  # ==========================================================================
  
  server_temp_off_persist_min:
    name: "Сервер: подтверждение низкой температуры (мин)"
    min: 5
    max: 60
    step: 5
    initial: 30
    icon: mdi:timer-sand

  server_fan_delay_min:
    name: "Сервер: задержка выключения вентилятора (мин)"
    min: 1
    max: 30
    step: 1
    initial: 5
    icon: mdi:timer-off

##############################################################################
#                          БИНАРНЫЕ СЕНСОРЫ
##############################################################################

binary_sensor:
  - platform: template
    sensors:
      # ======================================================================
      # МОНИТОРИНГ ПРОФИЛАКТИКИ ИБП
      # ======================================================================
      
      # ----------------------------------------------------------------------
      # Роутер на профилактике ИБП
      # ----------------------------------------------------------------------
      ups_maintenance_router:
        unique_id: ups_maintenance_router
        friendly_name: "Роутер на профилактике ИБП"
        device_class: problem
        availability_template: >
          {{ states('switch.my_multi_outlet_left') not in ['unknown','unavailable',''] }}
        value_template: >
          {{ is_state('switch.my_multi_outlet_left', 'off') }}
        icon_template: >-
          {% if is_state('switch.my_multi_outlet_left', 'off') %}
            mdi:power-plug-off
          {% else %}
            mdi:power-plug
          {% endif %}

      # ----------------------------------------------------------------------
      # МиниПК на профилактике ИБП
      # ----------------------------------------------------------------------
      ups_maintenance_minipc:
        unique_id: ups_maintenance_minipc
        friendly_name: "МиниПК на профилактике ИБП"
        device_class: problem
        availability_template: >
          {{ states('switch.my_multi_outlet_right') not in ['unknown','unavailable',''] }}
        value_template: >
          {{ is_state('switch.my_multi_outlet_right', 'off') }}
        icon_template: >-
          {% if is_state('switch.my_multi_outlet_right', 'off') %}
            mdi:power-plug-off
          {% else %}
            mdi:power-plug
          {% endif %}

      # ======================================================================
      # КОНТРОЛЬ ТЕМПЕРАТУРЫ С ГИСТЕРЕЗИСОМ
      # ======================================================================
      
      # ----------------------------------------------------------------------
      # Высокая температура сервера (с гистерезисом)
      # ----------------------------------------------------------------------
      # ЛОГИКА:
      # • Включение: температура > 30°C (порог включения)
      # • Выключение: температура < 28°C (порог выключения)
      # • Задержка включения: 2 минуты (защита от кратковременных скачков)
      #
      # ГИСТЕРЕЗИС:
      # ┌──────────────────────────────────────────┐
      # │ 30°C ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ ← Включение
      # │                                          │
      # │ 29°C - - - - - - - - - - - - - - - - - -│
      # │                                          │
      # │ 28°C ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ ← Выключение
      # └──────────────────────────────────────────┘
      #
      # ПРЕИМУЩЕСТВА:
      # • Предотвращает частые переключения вентилятора
      # • Защищает реле от износа
      # • Обеспечивает плавное управление
      # ----------------------------------------------------------------------
      server_temp_high:
        unique_id: server_temp_high
        friendly_name: "Высокая температура сервера"
        device_class: problem
        availability_template: >
          {{ states('sensor.0xa4c13861a18df7c8_temperature') not in ['unknown','unavailable',''] }}
        value_template: >
          {% set temp   = states('sensor.0xa4c13861a18df7c8_temperature') | float(0) %}
          {% set high   = states('input_number.server_temp_high_threshold') | float(30) %}
          {% set low    = states('input_number.server_temp_low_threshold')  | float(28) %}
          {% set was_on = is_state('binary_sensor.server_temp_high','on') %}
          {{ (temp > low) if was_on else (temp > high) }}
        delay_on:
          minutes: 2 # Устойчиво высокая температура 2 минуты
        icon_template: >-
          {% if is_state('binary_sensor.server_temp_high', 'on') %}
            mdi:thermometer-alert
          {% else %}
            mdi:thermometer-check
          {% endif %}

##############################################################################
#                               ТАЙМЕРЫ
##############################################################################

timer:
  # ==========================================================================
  # Таймер подтверждения стабильной низкой температуры
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Проверка, что температура стабильно низкая (не кратковременный спад)
  # • Предотвращает преждевременное выключение вентилятора
  #
  # ДЛИТЕЛЬНОСТЬ:
  # • По умолчанию: 30 минут
  # • Настраивается через input_number.server_temp_off_persist_min
  #
  # ЛОГИКА:
  # • Запускается, когда температура падает ниже порога
  # • Если за 30 минут температура не поднялась — переходим к задержке выключения
  # • Если температура поднялась — таймер отменяется, вентилятор продолжает работать
  # ==========================================================================
  server_temp_off_persist:
    name: "Сервер: подтверждение низкой температуры"
    duration: "00:30:00" # Базовое значение; реальная длительность задаётся динамически
    icon: mdi:timer-sand

  # ==========================================================================
  # Таймер задержки выключения вентилятора (grace period)
  # ==========================================================================
  # НАЗНАЧЕНИЕ:
  # • Дополнительная задержка перед выключением вентилятора
  # • Позволяет серверной "доостыть" после достижения нормальной температуры
  #
  # ДЛИТЕЛЬНОСТЬ:
  # • По умолчанию: 5 минут
  # • Настраивается через input_number.server_fan_delay_min
  #
  # ЛОГИКА:
  # • Запускается после завершения таймера подтверждения
  # • Финальная проверка перед выключением вентилятора
  # • Если температура поднялась — таймер отменяется
  # ==========================================================================
  server_fan_delay:
    name: "Сервер: задержка выключения вентилятора"
    duration: "00:05:00" # Базовое значение; реальная длительность задаётся динамически
    icon: mdi:timer-off

##############################################################################
#                             АВТОМАТИЗАЦИИ
##############################################################################

automation:
  # ==========================================================================
  # МОНИТОРИНГ ИБП И ЭЛЕКТРОПИТАНИЯ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Уведомление о недоступности розетки (отключение электричества)
  # --------------------------------------------------------------------------
  - id: "12858001-138d-4238-97f9-e5a501c6fe18"
    alias: "Сервер: недоступность розетки (отключение электричества)"
    description: >
      Отправляет уведомление при недоступности розеток ИБП.
      
      ТРИГГЕР:
      • Розетка становится недоступной (unavailable) более 1 минуты
      • switch.my_multi_outlet_left (роутер)
      • switch.my_multi_outlet_right (Mini-PC)
      
      УСЛОВИЯ:
      • Фаза запуска завершена (система инициализирована)
      • Режим тишины выключен (уведомления разрешены)
      • Кто-то дома (есть кому получить уведомление)
      
      ДЕЙСТВИЯ:
      • Отправка уведомления мастеру
      • Запись в системный лог
      
      ВОЗМОЖНЫЕ ПРИЧИНЫ НЕДОСТУПНОСТИ:
      • Отключение электричества
      • Разряд ИБП
      • Неисправность ИБП
      • Проблемы с сетевым подключением
      
      ПРИМЕЧАНИЕ:
      • Задержка 1 минута защищает от ложных срабатываний
      • При восстановлении питания розетки автоматически станут доступны
    mode: single
    triggers:
      - trigger: state
        entity_id:
          - switch.my_multi_outlet_left
          - switch.my_multi_outlet_right
        to: "unavailable"
        for:
          minutes: 1
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: state
        entity_id: input_boolean.silent_mode
        state: "off"
      - condition: state
        entity_id: binary_sensor.someone_is_home_2
        state: "on"
    actions:
      - action: notify.master
        data:
          message: >
            ⚠️ Серверная: розетка недоступна!
            
            Устройство: {{ state_attr(trigger.entity_id, 'friendly_name') }}
            Розетка: {{ trigger.entity_id }}
            
            Возможные причины:
            • Отключение электричества
            • Разряд ИБП
            • Неисправность оборудования
            
            Проверьте состояние серверной!
      - action: system_log.write
        data:
          message: >
            Розетка {{ trigger.entity_id }} недоступна — уведомление отправлено.
          level: warning

  # ==========================================================================
  # УПРАВЛЕНИЕ ТЕМПЕРАТУРОЙ И ВЕНТИЛЯТОРОМ
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Контроль температуры серверной: управление вентилятором
  # --------------------------------------------------------------------------
  - id: "server_room_fan_control"
    alias: "Сервер: управление вентилятором по температуре"
    description: >
      Основная логика управления вентилятором серверной.
      
      ТРИГГЕРЫ:
      • Температура поднялась выше порога (30°C, 2 мин)
      • Температура опустилась ниже порога (28°C)
      
      УСЛОВИЯ:
      • Фаза запуска завершена
      • Датчик температуры доступен
      
      ДЕЙСТВИЯ (при перегреве):
      • Немедленное включение вентилятора
      • Отмена всех таймеров (подтверждения и задержки)
      • Запись в лог
      
      ДЕЙСТВИЯ (при охлаждении):
      • Запуск таймера подтверждения (30 мин)
      • Вентилятор продолжает работать
      • Запись в лог
      
      РЕЖИМ:
      • restart — при повторном срабатывании перезапускается
      • Защищает от конфликтов при быстрых изменениях температуры
      
      ЛОГИКА ГИСТЕРЕЗИСА:
      ┌────────────────────────────────────────┐
      │ 30°C ─────────────────────────────────│ ← Включение (ON)
      │                                        │
      │ 29°C - - - - - - - - - - - - - - - - │
      │      ↑ Вентилятор работает            │
      │ 28°C ─────────────────────────────────│ ← Начало выключения (OFF)
      │      ↓ Запуск таймеров                │
      └────────────────────────────────────────┘
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.server_temp_high
        from: "off"
        to: "on"
        id: high
      - trigger: state
        entity_id: binary_sensor.server_temp_high
        from: "on"
        to: "off"
        id: low
    conditions:
      - condition: state
        entity_id: input_boolean.system_startup_phase
        state: "off"
      - condition: template
        value_template: >
          {{ states('sensor.0xa4c13861a18df7c8_temperature') not in ['unknown','unavailable'] }}
    actions:
      - choose:
          # ====================================================================
          # СЦЕНАРИЙ 1: ТЕМПЕРАТУРА ВЫСОКАЯ → ВКЛЮЧИТЬ ВЕНТИЛЯТОР
          # ====================================================================
          - conditions:
              - condition: trigger
                id: high
            sequence:
              # Отменяем все таймеры (если они были запущены)
              - action: timer.cancel
                target:
                  entity_id:
                    - timer.server_temp_off_persist
                    - timer.server_fan_delay
              
              # Включаем вентилятор немедленно
              - action: fan.turn_on
                target:
                  entity_id: fan.server_fan
              
              # Логирование
              - action: system_log.write
                data:
                  message: >
                    Вентилятор сервера включён
                    (температура: {{ states('sensor.0xa4c13861a18df7c8_temperature') }}°C,
                    порог: {{ states('input_number.server_temp_high_threshold') }}°C).
                  level: info

          # ====================================================================
          # СЦЕНАРИЙ 2: ТЕМПЕРАТУРА НИЗКАЯ → ЗАПУСТИТЬ ТАЙМЕР ПОДТВЕРЖДЕНИЯ
          # ====================================================================
          - conditions:
              - condition: trigger
                id: low
              - condition: state
                entity_id: fan.server_fan
                state: "on"
            sequence:
              # Запускаем таймер подтверждения низкой температуры
              - action: timer.start
                target:
                  entity_id: timer.server_temp_off_persist
                data:
                  duration: >
                    {{ (states('input_number.server_temp_off_persist_min') | float(30) * 60) | int }}
              
              # Логирование
              - action: system_log.write
                data:
                  message: >
                    Запущен таймер подтверждения низкой температуры сервера
                    (температура: {{ states('sensor.0xa4c13861a18df7c8_temperature') }}°C,
                    порог: {{ states('input_number.server_temp_low_threshold') }}°C,
                    длительность: {{ states('input_number.server_temp_off_persist_min') }} мин).
                  level: info

  # --------------------------------------------------------------------------
  # Стабильная низкая температура → запуск задержки выключения
  # --------------------------------------------------------------------------
  - id: "server_temp_off_persist_finished"
    alias: "Сервер: стабильная низкая температура → задержка выключения"
    description: >
      Таймер подтверждения завершён — температура стабильно низкая.
      Запускается финальный таймер задержки (grace period).
      
      ТРИГГЕР:
      • Завершение таймера timer.server_temp_off_persist
      
      УСЛОВИЯ:
      • Температура всё ещё низкая (binary_sensor.server_temp_high = off)
      • Вентилятор включён
      
      ДЕЙСТВИЯ:
      • Запуск таймера задержки выключения (5 мин)
      • Запись в лог
      
      НАЗНАЧЕНИЕ ЗАДЕРЖКИ:
      • Дополнительное охлаждение серверной
      • Защита от быстрого повторного нагрева
      • "Запас прочности" перед выключением вентилятора
      
      ПОСЛЕДОВАТЕЛЬНОСТЬ ТАЙМЕРОВ:
      1. Температура падает → таймер подтверждения (30 мин)
      2. Таймер завершён → таймер задержки (5 мин)
      3. Задержка завершена → выключение вентилятора
      
      Итого: 35 минут от начала охлаждения до выключения вентилятора
    mode: single
    triggers:
      - trigger: event
        event_type: timer.finished
        event_data:
          entity_id: timer.server_temp_off_persist
    conditions:
      - condition: state
        entity_id: binary_sensor.server_temp_high
        state: "off"
      - condition: state
        entity_id: fan.server_fan
        state: "on"
    actions:
      # Запускаем финальный таймер задержки
      - action: timer.start
        target:
          entity_id: timer.server_fan_delay
        data:
          duration: >
            {{ (states('input_number.server_fan_delay_min') | float(5) * 60) | int }}
      
      # Логирование
      - action: system_log.write
        data:
          message: >
            Запущен таймер задержки выключения вентилятора сервера
            (температура: {{ states('sensor.0xa4c13861a18df7c8_temperature') }}°C,
            длительность: {{ states('input_number.server_fan_delay_min') }} мин).
          level: info

  # --------------------------------------------------------------------------
  # Финал: выключение вентилятора после задержки
  # --------------------------------------------------------------------------
  - id: "server_fan_delay_off"
    alias: "Сервер: выключение вентилятора по таймеру"
    description: >
      Финальное выключение вентилятора после полного цикла охлаждения.
      
      ТРИГГЕР:
      • Завершение таймера timer.server_fan_delay
      
      УСЛОВИЯ:
      • Температура всё ещё низкая (финальная проверка)
      
      ДЕЙСТВИЯ:
      • Выключение вентилятора
      • Запись в лог с указанием текущей температуры
      
      ПОЛНЫЙ ЦИКЛ ОХЛАЖДЕНИЯ:
      ┌────────────────────────────────────────────────────────────┐
      │ 1. Температура > 30°C (2 мин устойчиво)                   │
      │    ↓                                                       │
      │ 2. Включение вентилятора                                  │
      │    ↓                                                       │
      │ 3. Температура < 28°C                                     │
      │    ↓                                                       │
      │ 4. Таймер подтверждения (30 мин)                          │
      │    ↓                                                       │
      │ 5. Таймер задержки (5 мин)                                │
      │    ↓                                                       │
      │ 6. Выключение вентилятора ← ВЫ ЗДЕСЬ                      │
      └────────────────────────────────────────────────────────────┘
      
      ЗАЩИТА ОТ ПРЕЖДЕВРЕМЕННОГО ВЫКЛЮЧЕНИЯ:
      • Если температура поднялась на любом этапе — таймеры отменяются
      • Вентилятор продолжает работать до нового цикла охлаждения
    mode: single
    triggers:
      - trigger: event
        event_type: timer.finished
        event_data:
          entity_id: timer.server_fan_delay
    conditions:
      - condition: state
        entity_id: binary_sensor.server_temp_high
        state: "off"
    actions:
      # Выключаем вентилятор
      - action: fan.turn_off
        target:
          entity_id: fan.server_fan
      
      # Логирование с детальной информацией
      - action: system_log.write
        data:
          message: >
            Вентилятор сервера выключен по таймеру.
            Текущая температура: {{ states('sensor.0xa4c13861a18df7c8_temperature') }}°C.
            Порог выключения: {{ states('input_number.server_temp_low_threshold') }}°C.
            Общее время работы: ~{{ (states('input_number.server_temp_off_persist_min') | float(30) 
            + states('input_number.server_fan_delay_min') | float(5)) | int }} мин.
          level: info